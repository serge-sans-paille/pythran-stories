<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Being more than a translator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="serge-sans-paille and other pythraners">

    <!-- Le styles -->
    <link rel="stylesheet" href="./theme/css/bootstrap.min.css" type="text/css" />
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
      .tag-1 {
        font-size: 13pt;
      }
      .tag-2 {
        font-size: 10pt;
      }
      .tag-2 {
        font-size: 8pt;
      }
      .tag-4 {
        font-size: 6pt;
     }
    </style>
    <link href="./theme/css/bootstrap-responsive.min.css" rel="stylesheet">
        <link href="./theme/css/font-awesome.css" rel="stylesheet">

    <link href="./theme/css/pygments.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="./theme/images/favicon.ico">
    <link rel="apple-touch-icon" href="./theme/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="./theme/images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="./theme/images/apple-touch-icon-114x114.png">

    <link href="./" type="application/atom+xml" rel="alternate" title="Pythran stories ATOM Feed" />

  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="./index.html">Pythran stories </a>
          <div class="nav-collapse">
            <ul class="nav">
                          <li class="divider-vertical"></li>
                  <li >
                    <a href="./category/benchmark.html">
						<i class="icon-folder-open icon-large"></i>benchmark
					</a>
                  </li>
                  <li >
                    <a href="./category/compilation.html">
						<i class="icon-folder-open icon-large"></i>compilation
					</a>
                  </li>
                  <li >
                    <a href="./category/cython.html">
						<i class="icon-folder-open icon-large"></i>cython
					</a>
                  </li>
                  <li >
                    <a href="./category/engineering.html">
						<i class="icon-folder-open icon-large"></i>engineering
					</a>
                  </li>
                  <li >
                    <a href="./category/examples.html">
						<i class="icon-folder-open icon-large"></i>examples
					</a>
                  </li>
                  <li class="active">
                    <a href="./category/optimisation.html">
						<i class="icon-folder-open icon-large"></i>optimisation
					</a>
                  </li>
                  <li >
                    <a href="./category/release.html">
						<i class="icon-folder-open icon-large"></i>release
					</a>
                  </li>

                          <ul class="nav pull-right">
                                <li><a href="./archives.html"><i class="icon-th-list"></i>Archives</a></li>
                          </ul>

            </ul>
            <!--<p class="navbar-text pull-right">Logged in as <a href="#">username</a></p>-->
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row">
        <div class="span9" id="content">
<section id="content">
        <article>
                <header>
                        <h1>
                                <a href=""
                                        rel="bookmark"
                                        title="Permalink to Being more than a translator">
                                        Being more than a translator
                                </a>
                        </h1>
                </header>
                <div class="entry-content">
                <div class="well">
<footer class="post-info">
<span class="label">Date</span>
<abbr class="published" title="2018-01-12T00:00:00+01:00">
        <i class="icon-calendar"></i>Fri 12 January 2018
</abbr>
<span class="label">By</span>
<a href="./author/serge-sans-paille.html"><i class="icon-user"></i>serge-sans-paille</a>
<span class="label">Category</span>
<a href="./category/optimisation.html"><i class="icon-folder-open"></i>optimisation</a>.


</footer><!-- /.post-info -->                </div>
                <p>This blogpost originally was a Jupyter Notebook. You can <a href="notebooks/Being more than a Python translator.ipynb">download it</a> if you want. The conversion was done using <code>nbconvert</code> and a <a href="notebooks/nbmarkdown.tpl">custom template</a> to match the style of the other part of the blog.</p>
<p>Special thanks to w1gz for his review btw <code>o/</code></p>
<h1>Optimizing with Cython</h1>
<p><a href="http://jakevdp.github.io/pages/about.html">Jake VanderPlas</a> recently wrote a <a href="http://jakevdp.github.io/blog/2017/12/11/live-coding-cython-ising-model/">blogpost about Cython</a>, where the following piece of Python code and the associated benchmark can be found:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">ising_step</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.4</span><span class="p">):</span>
<span class="o">...</span>     
<span class="o">...</span>     <span class="n">N</span><span class="p">,</span> <span class="n">M</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">shape</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">n_offset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
<span class="o">...</span>         <span class="k">for</span> <span class="n">m_offset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
<span class="o">...</span>             <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_offset</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
<span class="o">...</span>                 <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m_offset</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
<span class="o">...</span>                     <span class="n">_ising_update</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">beta</span><span class="p">))</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">field</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">_ising_update</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">beta</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
<span class="o">...</span>     <span class="n">N</span><span class="p">,</span> <span class="n">M</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">shape</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="p">):</span>
<span class="o">...</span>         <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="o">+</span><span class="mi">2</span><span class="p">):</span>
<span class="o">...</span>             <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">==</span> <span class="n">m</span><span class="p">:</span>
<span class="o">...</span>                 <span class="k">continue</span>
<span class="o">...</span>             <span class="n">total</span> <span class="o">+=</span> <span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="o">%</span> <span class="n">N</span><span class="p">,</span> <span class="n">j</span><span class="o">%</span> <span class="n">M</span><span class="p">]</span>
<span class="o">...</span>     <span class="n">dE</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">field</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">]</span> <span class="o">*</span> <span class="n">total</span>
<span class="o">...</span>     <span class="k">if</span> <span class="n">dE</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<span class="o">...</span>         <span class="n">field</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
<span class="o">...</span>     <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">dE</span> <span class="o">*</span> <span class="n">beta</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">():</span>
<span class="o">...</span>         <span class="n">field</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">random_spin_field</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">field</span> <span class="o">=</span> <span class="n">random_spin_field</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">ising_step</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span>1 loop, best of 3: 938 ms per loop
</pre></div>


<p>The blogpost also contains a Cython implementation of the same kernel:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%</span><span class="n">load_ext</span> <span class="n">cython</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%%</span><span class="n">cython</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">cimport</span> <span class="n">cython</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">cimport</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">libc.math</span> <span class="nn">cimport</span> <span class="nn">exp</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">libc.stdlib</span> <span class="nn">cimport</span> <span class="nn">rand</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">cdef</span> <span class="n">extern</span> <span class="kn">from</span> <span class="s2">&quot;limits.h&quot;</span><span class="p">:</span>
<span class="o">...</span>     <span class="nb">int</span> <span class="n">RAND_MAX</span>
<span class="o">...</span> 
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="nd">@cython.boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nd">@cython.wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">cy_ising_step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64_t</span><span class="p">[:,</span> <span class="p">:]</span> <span class="n">field</span><span class="p">,</span> <span class="nb">float</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.4</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">cdef</span> <span class="nb">int</span> <span class="n">N</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="o">...</span>     <span class="n">cdef</span> <span class="nb">int</span> <span class="n">M</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="o">...</span>     <span class="n">cdef</span> <span class="nb">int</span> <span class="n">n_offset</span><span class="p">,</span> <span class="n">m_offset</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">n_offset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
<span class="o">...</span>         <span class="k">for</span> <span class="n">m_offset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
<span class="o">...</span>             <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_offset</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
<span class="o">...</span>                 <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m_offset</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
<span class="o">...</span>                     <span class="n">_cy_ising_update</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
<span class="o">...</span> 
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="nd">@cython.boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nd">@cython.wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">cdef</span> <span class="n">_cy_ising_update</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64_t</span><span class="p">[:,</span> <span class="p">:]</span> <span class="n">field</span><span class="p">,</span> <span class="nb">int</span> <span class="n">n</span><span class="p">,</span> <span class="nb">int</span> <span class="n">m</span><span class="p">,</span> <span class="nb">float</span> <span class="n">beta</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">cdef</span> <span class="nb">int</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
<span class="o">...</span>     <span class="n">cdef</span> <span class="nb">int</span> <span class="n">N</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="o">...</span>     <span class="n">cdef</span> <span class="nb">int</span> <span class="n">M</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="o">...</span>     <span class="n">cdef</span> <span class="nb">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="p">):</span>
<span class="o">...</span>         <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="o">+</span><span class="mi">2</span><span class="p">):</span>
<span class="o">...</span>             <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">==</span> <span class="n">m</span><span class="p">:</span>
<span class="o">...</span>                 <span class="k">continue</span>
<span class="o">...</span>             <span class="n">total</span> <span class="o">+=</span> <span class="n">field</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">N</span><span class="p">,</span> <span class="n">j</span> <span class="o">%</span> <span class="n">M</span><span class="p">]</span>
<span class="o">...</span>     <span class="n">cdef</span> <span class="nb">float</span> <span class="n">dE</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">field</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">]</span> <span class="o">*</span> <span class="n">total</span>
<span class="o">...</span>     <span class="k">if</span> <span class="n">dE</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<span class="o">...</span>         <span class="n">field</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
<span class="o">...</span>     <span class="k">elif</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">dE</span> <span class="o">*</span> <span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="n">RAND_MAX</span> <span class="o">&gt;</span> <span class="n">rand</span><span class="p">():</span>
<span class="o">...</span>         <span class="n">field</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
<span class="o">...</span> 
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">cy_ising_step</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span>The slowest run took 4.57 times longer than the fastest. This could mean that an intermediate result is being cached.
100 loops, best of 3: 8.64 ms per loop
</pre></div>


<p>As expected, this is much faster than the Python version which uses explicit loops. Here, Cython is typically used as a <em>guided translater</em>. It translates Python code into C code, using the type annotations and the extra Cython directives to drive the translation process, removing most of the calls to the Python C API.</p>
<h1>Using the Pythran compiler</h1>
<p>When I wanted to use Pythran to convert the original Python code into native code, I went the traditional Pythran way, i.e. <em>copy paste the Python code, add a <code>#pythran export</code> line and that's all folks</em>. Unfortunately, I ended up with a code roughly two times slower than the Cython version. That's still good with respect to the Python version, but a bit disapointing.</p>
<p>So I did some benchmarking, compared the C code generated by Cython and the C++ code generated by Pythran, made sure the compiler flags were similar etc. And I realized that Pythran is using <code>int64</code> for Python integers, including loop indices, whereas the Cython version of this kernel is specialized to use <code>int</code>. So I was not comparing the same computations. In a similar manner the Pythran version -- just like the Python version -- uses double precision floating pointer numbers, whereas Cython version is specialized to use single precision number.</p>
<p>This alone should not explain the difference between the two implementations, but it turns out it does, because one of the hotspot of the program is the modulo computation in the loop indexing. Indeed, the modulo is a relatively costly operation compared to an add, and even a branch mis prediction, check this <a href="http://ithare.com/infographics-operation-costs-in-cpu-clock-cycles/">great table</a> for some reminder about that. Moreover, the cost of the modulo increases with the integer size.</p>
<p>After some tinkering, and <em>without</em> changing the original Python code, I managed to get Pythran produce a code that runs faster than the Cython version, without changing the integer type. Demonstration:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">pythran</span>
<span class="o">&gt;&gt;&gt;</span> <span class="o">%</span><span class="n">load_ext</span> <span class="n">pythran</span><span class="o">.</span><span class="n">magic</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%%</span><span class="n">pythran</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="c1">#pythran export ising_step(int64[:,:])</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">ising_step</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.4</span><span class="p">):</span>
<span class="o">...</span>     
<span class="o">...</span>     <span class="n">N</span><span class="p">,</span> <span class="n">M</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">shape</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">n_offset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
<span class="o">...</span>         <span class="k">for</span> <span class="n">m_offset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
<span class="o">...</span>             <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_offset</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
<span class="o">...</span>                 <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m_offset</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
<span class="o">...</span>                     <span class="n">_ising_update</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">field</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">_ising_update</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">beta</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
<span class="o">...</span>     <span class="n">N</span><span class="p">,</span> <span class="n">M</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">shape</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="p">):</span>
<span class="o">...</span>         <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="o">+</span><span class="mi">2</span><span class="p">):</span>
<span class="o">...</span>             <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">==</span> <span class="n">m</span><span class="p">:</span>
<span class="o">...</span>                 <span class="k">continue</span>
<span class="o">...</span>             <span class="n">total</span> <span class="o">+=</span> <span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="o">%</span> <span class="n">N</span><span class="p">,</span> <span class="n">j</span><span class="o">%</span> <span class="n">M</span><span class="p">]</span>
<span class="o">...</span>     <span class="n">dE</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">field</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">]</span> <span class="o">*</span> <span class="n">total</span>
<span class="o">...</span>     <span class="k">if</span> <span class="n">dE</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<span class="o">...</span>         <span class="n">field</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
<span class="o">...</span>     <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">dE</span> <span class="o">*</span> <span class="n">beta</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">():</span>
<span class="o">...</span>         <span class="n">field</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
<span class="o">...</span> 
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">ising_step</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span>100 loops, best of 3: 7.76 ms per loop
</pre></div>


<p>The timings gets even better if <code>beta</code> is forced into a single precision float, to match Cython's code, but that's not the goal of this article.</p>
<p>So what happened? That's the topic of the second part of this post :-)</p>
<h1>Implementing a new Pythran optimization</h1>
<p>Once one realizes that the above code is bound by the modulo computation, the natural optimization goal becomes to <em>get rid of the modulo</em>. One way to do so is to notice that in the two expressions <code>i % N</code> and <code>i % M</code> (let us denote them as <code>i_n</code> and <code>i_m</code>):</p>
<ol>
<li>
<p><code>i</code> and <code>j</code> are loop induction variables, iterating through an <em>increasing</em> range;</p>
</li>
<li>
<p><code>N</code> and <code>M</code> are positive values.</p>
</li>
</ol>
<p>Thanks to the above properties, instead of computing the modulo each time, it is possible to use the inductive formula <code>i_n = i_n + 1 if i_n == N - 1 else O</code>.</p>
<p><code>i</code> and <code>j</code> being loop induction variables is relatively simple, Pythran already provides the <a href="http://serge-sans-paille.github.io/pythran-stories/identifier-binding-computation.html">tooling for identifier binding</a>, so binding the identifier <code>range</code> to the according builtin is not an issue, and walking the <a href="https://en.wikipedia.org/wiki/Use-define_chain">use-def chain</a> is also within the scope of Pythran analyses.</p>
<p><code>N</code> being positive can be deduced from it's assignment, which results from tuple unpacking of an array shape. And a shape only contains positive numbers.</p>
<p>Pythran models the <code>shape</code> attribute correctly and can see through the type destructuring after a simplification step. Let's showcase that and use it as an opportunity to use some Pythran internals.</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">pythran</span> <span class="kn">import</span> <span class="n">passmanager</span><span class="p">,</span> <span class="n">backend</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">gast</span> <span class="kn">as</span> <span class="nn">ast</span>
</pre></div>


<p><code>gast</code> is just a thin portability layer over the Python standard <code>ast</code> module. It provides the same API with a few extra and helps to cope with Python2/Python3 transition.</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">&gt;&gt;&gt; def upper_dim(dat):</span>
<span class="s1">...     M, _ = dat.shape</span>
<span class="s1">...     return M</span>
<span class="s1">&gt;&gt;&gt; &#39;&#39;&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">node</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
</pre></div>


<p>We first instanciate a pass manager to apply Pythran's transformation. A few normalization steps are necessary. These refinments are important for Pythran because it puts the Python AST into a normalized form easier to process for Pythran optimizations.</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">pythran.transformations</span> <span class="kn">import</span> <span class="n">NormalizeTuples</span><span class="p">,</span> <span class="n">NormalizeMethodCalls</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">pm</span> <span class="o">=</span> <span class="n">passmanager</span><span class="o">.</span><span class="n">PassManager</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">pm</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">NormalizeTuples</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">pm</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">NormalizeMethodCalls</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span>(True, &amp;lt;gast.gast.Module at 0x7f00c4fa32d0&amp;gt;)
</pre></div>


<p>True means something got changed in the process, and by using the Python backend of Pythran, we can get back a Python view of the transformed code:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">Python</span><span class="p">,</span> <span class="n">node</span><span class="p">))</span>
</pre></div>


<div class="highlight"><pre><span></span>def upper_dim(dat):
    M = __builtin__.getattr(dat, &#39;shape&#39;)[0]
    _ = __builtin__.getattr(dat, &#39;shape&#39;)[1]
    return M
</pre></div>


<p>Using the <code>RangeValue</code> analysis, it is possible to collect range information about the various nodes and variables in this function:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">pythran.analyses</span> <span class="kn">import</span> <span class="n">RangeValues</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">RangeValues</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">rv</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">]</span>
</pre></div>


<div class="highlight"><pre><span></span>Interval(low=0, high=inf)
</pre></div>


<p>In the end given a simple representation of the original code, a (simplified) Pythran pipeline can optimize it into a Python code that can be translated to more efficient native code:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">&gt;&gt;&gt; def foo(x):</span>
<span class="s1">...     y = len(x)</span>
<span class="s1">...     for i in range(3):</span>
<span class="s1">...         z = i % y</span>
<span class="s1">&gt;&gt;&gt; &#39;&#39;&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">node</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">pythran.transformations</span> <span class="kn">import</span> <span class="n">ExpandBuiltins</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">pythran.optimizations</span> <span class="kn">import</span> <span class="n">ModIndex</span><span class="p">,</span> <span class="n">IterTransformation</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">pm</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">ExpandBuiltins</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">pm</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">IterTransformation</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">pm</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">ModIndex</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">Python</span><span class="p">,</span> <span class="n">node</span><span class="p">))</span>
</pre></div>


<div class="highlight"><pre><span></span>def foo(x):
    y = __builtin__.len(x)
    i_m = ((0 - 1) % y)
    for i in __builtin__.xrange(3):
        i_m = (0 if ((i_m + 1) == y) else (i_m + 1))
        z = i_m
</pre></div>


<p>Here is a summary of what happens:</p>
<ol>
<li><code>Expand Builtins</code> makes sure any identifier that is availble because the <code>_builtin__</code> module (<code>buitlins</code> in Python3) is loaded by default have their full path specified. It turns <code>range</code> into <code>__builtin__.range</code>.</li>
<li><code>Iter Tranformation</code> turns functions that create list into their counterpart that creats a generator, when it is legal (<code>map</code> â†’ <code>itertools.imap</code> etc, in Python2 terminology).</li>
<li><code>Mod Index</code> simplifies the modulo operation</li>
</ol>
<p>Extra transformation could be applied, just for the fun of it:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">pythran.transformations</span> <span class="kn">import</span> <span class="n">FalsePolymorphism</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">pythran.optimizations</span> <span class="kn">import</span> <span class="n">DeadCodeElimination</span><span class="p">,</span> <span class="n">LoopFullUnrolling</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="n">pm</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">LoopFullUnrolling</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">pm</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">FalsePolymorphism</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>  <span class="c1"># basically scalar renaming</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="k">while</span> <span class="n">pm</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">DeadCodeElimination</span><span class="p">,</span> <span class="n">node</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
<span class="o">...</span>     <span class="k">pass</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">Python</span><span class="p">,</span> <span class="n">node</span><span class="p">))</span>
</pre></div>


<div class="highlight"><pre><span></span>def foo(x):
    pass
    pass
    pass
    pass
    pass
    pass
    pass
    pass
    pass
    pass
    pass
</pre></div>


<h1>Conclusion</h1>
<p>The transformation described in this post could be made more generic (by supporting a broader range of expression as modulo parameter for instance). Still it showcases the underlying idea of Pythran: given enough test cases, it should be possible to pile more and more transformations, so that the user can focus on writing code, and let the compiler take care of all the details, taking advantage of all the knowledge gathered in the compiler.</p>
<p>There's a great benefit to reason at Python's level: the builtins provide high-level functionality whose semantic carries information a smart enough compiler can take advantage of.</p>
                </div><!-- /.entry-content -->
        </article>
</section>
        </div><!--/span-->

                <div class="span3 well sidebar-nav" id="sidebar">
<ul class="nav nav-list">
<li class="nav-header"><h4><i class="icon-external-link"></i>blogroll</h4></li>
    <li><a href="http://pythonhosted.org/pythran"><i class="icon-external-link"></i>Pythran Doc</a></li>
    <li><a href="https://pypi.python.org/pypi/pythran"><i class="icon-external-link"></i>Pythran on PyPI</a></li>
<li class="nav-header"><h4><i class="icon-home icon-large"></i> social</h4></li>
<li><a href="./feeds/all.atom.xml" rel="alternate"><i class="icon-bookmark icon-large"></i>atom feed</a></li>
    <li><a href="https://github.com/serge-sans-paille/pythran"><i class="icon-github-sign icon-large"></i>github</a></li>

<li class="nav-header"><h4><i class="icon-folder-close icon-large"></i>Categories</h4></li>
<li>
<a href="./category/benchmark.html">
    <i class="icon-folder-open icon-large"></i>benchmark
</a>
</li>
<li>
<a href="./category/compilation.html">
    <i class="icon-folder-open icon-large"></i>compilation
</a>
</li>
<li>
<a href="./category/cython.html">
    <i class="icon-folder-open icon-large"></i>cython
</a>
</li>
<li>
<a href="./category/engineering.html">
    <i class="icon-folder-open icon-large"></i>engineering
</a>
</li>
<li>
<a href="./category/examples.html">
    <i class="icon-folder-open icon-large"></i>examples
</a>
</li>
<li>
<a href="./category/optimisation.html">
    <i class="icon-folder-open icon-large"></i>optimisation
</a>
</li>
<li>
<a href="./category/release.html">
    <i class="icon-folder-open icon-large"></i>release
</a>
</li>

<li class="nav-header"><h4><i class="icon-tags icon-large"></i>Tags</h4></li>


</ul>        </div><!--/.well -->

      </div><!--/row-->

      <hr>

      <footer>
        <address id="about">
                Proudly powered by <a href="http://pelican.notmyidea.org/">Pelican <i class="icon-external-link"></i></a>,
                                which takes great advantage of <a href="http://python.org">Python <i class="icon-external-link"></i></a>.
        </address><!-- /#about -->

        <p>The theme is from <a href="http://twitter.github.com/bootstrap/">Bootstrap from Twitter <i class="icon-external-link"></i></a>,
                   and <a href="http://fortawesome.github.com/Font-Awesome/">Font-Awesome <i class="icon-external-link"></i></a>, thanks!</p>
      </footer>

    </div><!--/.fluid-container-->



    <!-- Le javascript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="./theme/js/jquery-1.7.2.min.js"></script>
    <script src="./theme/js/bootstrap.min.js"></script>
  </body>
</html>