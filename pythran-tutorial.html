<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Pythran Tutorial</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="serge-sans-paille and other pythraners">

    <!-- Le styles -->
    <link rel="stylesheet" href="./theme/css/bootstrap.min.css" type="text/css" />
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
      .tag-1 {
        font-size: 13pt;
      }
      .tag-2 {
        font-size: 10pt;
      }
      .tag-2 {
        font-size: 8pt;
      }
      .tag-4 {
        font-size: 6pt;
     }
    </style>

    <link href="./theme/css/bootstrap-responsive.min.css" rel="stylesheet">
        <link href="./theme/css/font-awesome.css" rel="stylesheet">

    <link href="./theme/css/pygments.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="./theme/images/favicon.ico">
    <link rel="apple-touch-icon" href="./theme/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="./theme/images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="./theme/images/apple-touch-icon-114x114.png">

    <link href="./" type="application/atom+xml" rel="alternate" title="Pythran stories ATOM Feed" />

  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="./index.html">Pythran stories </a>
          <div class="nav-collapse">
            <ul class="nav">
                          <li class="divider-vertical"></li>
                  <li >
                    <a href="./category/benchmark.html">
						<i class="icon-folder-open icon-large"></i>benchmark
					</a>
                  </li>
                  <li >
                    <a href="./category/compilation.html">
						<i class="icon-folder-open icon-large"></i>compilation
					</a>
                  </li>
                  <li class="active">
                    <a href="./category/examples.html">
						<i class="icon-folder-open icon-large"></i>examples
					</a>
                  </li>
                  <li >
                    <a href="./category/optimisation.html">
						<i class="icon-folder-open icon-large"></i>optimisation
					</a>
                  </li>
                  <li >
                    <a href="./category/release.html">
						<i class="icon-folder-open icon-large"></i>release
					</a>
                  </li>

                          <ul class="nav pull-right">
                                <li><a href="./archives.html"><i class="icon-th-list"></i>Archives</a></li>
                          </ul>

            </ul>
            <!--<p class="navbar-text pull-right">Logged in as <a href="#">username</a></p>-->
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row">
        <div class="span9" id="content">
<section id="content">
        <article>
                <header>
                        <h1>
                                <a href=""
                                        rel="bookmark"
                                        title="Permalink to Pythran Tutorial">
                                        Pythran Tutorial
                                </a>
                        </h1>
                </header>
                <div class="entry-content">
                <div class="well">
<footer class="post-info">
<span class="label">Date</span>
<abbr class="published" title="2016-07-18T00:00:00+02:00">
        <i class="icon-calendar"></i>Mon 18 July 2016
</abbr>
<span class="label">By</span>
<a href="./author/serge-sans-paille.html"><i class="icon-user"></i>serge-sans-paille</a>
<span class="label">Category</span>
<a href="./category/examples.html"><i class="icon-folder-open"></i>examples</a>.


</footer><!-- /.post-info -->                </div>
                <p>Pythran presentation hold on Universit√© Lyon1 on Monday 27th June together with a Julia presentation, and later at <a href="http://compas2016.sciencesconf.org/">Compas'2016</a>.</p>
<p>This blogpost originally was a Jupyter Notebook. You can <a href="notebooks/Pythran Tutorial.ipynb">download it</a> if you want. The conversion was done using <code>nbconvert</code> and a <a href="notebooks/nbmarkdown.tpl">custom template</a> to match the style of the other part of the blog.</p>
<h2>Prelude</h2>
<p>Pythran is a compiler that turns numerical kernels into native modules.</p>
<p>You can download it on:</p>
<ul>
<li>PyPI: <code>pip install pythran</code></li>
<li>Conda: <code>conda install pythran</code></li>
</ul>
<p>Linux, OSX and Windows (through WinPython) are supported.</p>
<p>Partial Python3 support.</p>
<h1>Introduction with Pi computation</h1>
<p>Computing $\pi$ is quite old fashined, but it's a good start to learn Pythran!</p>
<p>Here is a Fortran-like version:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">pi_approximate</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">step</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">n</span>
<span class="o">...</span>     <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>   
<span class="o">...</span>     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="o">...</span>         <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span>
<span class="o">...</span>         <span class="n">result</span> <span class="o">+=</span> <span class="mf">4.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">step</span> <span class="o">*</span> <span class="n">result</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="n">pi_approximate</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)</span>
</pre></div>


<p>We can get a first glimpse of its performance using the <code>timeit</code> module:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">pi_approximate</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)</span>
</pre></div>


<p>Turning this code into Pythran code is relatively easy. First we need to import Pythran:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">pythran</span>
</pre></div>


<p>And load it's notebook integration mode:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%</span><span class="n">load_ext</span> <span class="n">pythran</span><span class="o">.</span><span class="n">magic</span>
</pre></div>


<p>Now we'll just reproduce the code above, with an additionnal line to tell pythran about the argument type. the return type is infered.</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%%</span><span class="n">pythran</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c1">#pythran export pi_approximate_pythran(int)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">pi_approximate_pythran</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">step</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">n</span>
<span class="o">...</span>     <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>   
<span class="o">...</span>     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="o">...</span>         <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span>
<span class="o">...</span>         <span class="n">result</span> <span class="o">+=</span> <span class="mf">4.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">step</span> <span class="o">*</span> <span class="n">result</span>
</pre></div>


<p>Hopefully, the code behaves the same:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">pi_approximate_pythran</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)</span>
</pre></div>


<p>But it runs faster!</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">pi_approximate_pythran</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)</span>
</pre></div>


<p>Can we go faster? The astute reader has already noticed that the loop can run in parallel, so let's use OpenMP integration:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%%</span><span class="n">pythran</span> <span class="o">-</span><span class="n">fopenmp</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c1">#pythran export pi_approximate_pythran_omp(int)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">pi_approximate_pythran_omp</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">step</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">n</span>
<span class="o">...</span>     <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
<span class="o">...</span>     <span class="c1">#omp parallel for reduction(+:result)</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="o">...</span>         <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span>
<span class="o">...</span>         <span class="n">result</span> <span class="o">+=</span> <span class="mf">4.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">step</span> <span class="o">*</span> <span class="n">result</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">pi_approximate_pythran_omp</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)</span>
</pre></div>


<p>But everything looks very Fortran-ish in this example. Why not trying the following:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">pi_numpy_style</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">step</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">n</span>
<span class="o">...</span>     <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">step</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mf">4.</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>


<p>It works the same, but it's already faster as most of the computations are done using native code:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">pi_numpy_style</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">pi_numpy_style</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)</span>
</pre></div>


<p>Good new! Pythran can also handle this version, without much changes:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%%</span><span class="n">pythran</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c1">#pythran export pi_numpy_style_pythran(int)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">pi_numpy_style_pythran</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">step</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">n</span>
<span class="o">...</span>     <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">step</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mf">4.</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>


<p>It still works, and runs almost as fast as the numpy-free version converted by Pythran:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">pi_numpy_style_pythran</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">pi_numpy_style_pythran</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)</span>
</pre></div>


<p>Cherry on the cake: Pythran can take advantage of the vectorized code to generate SIMD code:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%%</span><span class="n">pythran</span> <span class="o">-</span><span class="n">DUSE_BOOST_SIMD</span> <span class="o">-</span><span class="n">march</span><span class="o">=</span><span class="n">native</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c1">#pythran export pi_numpy_style_pythran_simd(int)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">pi_numpy_style_pythran_simd</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">step</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">n</span>
<span class="o">...</span>     <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">step</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mf">4.</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">pi_numpy_style_pythran_simd</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)</span>
</pre></div>


<h2>Pythran in a nutshell</h2>
<ul>
<li>DSL embeded into Python (no technological debt)</li>
<li>Minimalists type annotations (only the exported functions)</li>
<li>Parallelization and Vectorization are possible</li>
<li>Supports (an already large part of) Numpy and Python builtins</li>
</ul>
<h1>Type Annotations</h1>
<p>Consider the following function:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">pairwise_distance</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">X</span><span class="p">[:,</span> <span class="bp">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">X</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</pre></div>


<p>It makes use of fancy indexing, broadcasting and Numpy. And it's polymorphic!</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">100</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">args32</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">args64</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>  <span class="c1">#cast useless</span>
<span class="o">&gt;&gt;&gt;</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">pairwise_distance</span><span class="p">(</span><span class="n">args32</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">pairwise_distance</span><span class="p">(</span><span class="n">args64</span><span class="p">)</span>
</pre></div>


<p>Pythran can handle all of this! Note the double export to specify the overloads:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%%</span><span class="n">pythran</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c1">#pythran export pairwise_distance_pythran(float32[][])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c1">#pythran export pairwise_distance_pythran(float64[:,:])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">pairwise_distance_pythran</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">print</span> <span class="n">X</span><span class="o">.</span><span class="n">dtype</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">X</span><span class="p">[:,</span> <span class="bp">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">X</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">pairwise_distance_pythran</span><span class="p">(</span><span class="n">args32</span><span class="p">)</span><span class="o">.</span><span class="n">dtype</span>
<span class="o">&gt;&gt;&gt;</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">pairwise_distance_pythran</span><span class="p">(</span><span class="n">args32</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">pairwise_distance_pythran</span><span class="p">(</span><span class="n">args64</span><span class="p">)</span><span class="o">.</span><span class="n">dtype</span>
<span class="o">&gt;&gt;&gt;</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">pairwise_distance_pythran</span><span class="p">(</span><span class="n">args64</span><span class="p">)</span>
</pre></div>


<p>Pythran also automatically handles transposed arguments, without making a copy:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">pairwise_distance_pythran</span><span class="p">(</span><span class="n">args64</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</pre></div>


<p>There's more than arrays and scalars in Pythran types. What about... a tuple of tuple of complex numbers, lists and sets?</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%%</span><span class="n">pythran</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c1">#pythran export wtf((int, complex128, (int set, int list, int:str dict)))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">wtf</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">x</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">wtf</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">strange_arg</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1j</span><span class="p">,</span> <span class="p">({</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;unan&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;daou&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;tri&#39;</span><span class="p">})</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">wtf</span><span class="p">(</span><span class="n">strange_arg</span><span class="p">)</span>
</pre></div>


<p>Beware that Pythran works on a copy when passing <code>tuple</code>, <code>list</code>, <code>set</code> or <code>dict</code> in the Pythran world (it's ok for <code>ndarray</code> as it does not copy the whole data):</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">wtf</span><span class="p">(</span><span class="n">strange_arg</span><span class="p">)</span> <span class="ow">is</span> <span class="n">strange_arg</span>
</pre></div>


<p>Sometimes, you feel like using very long function prototypes. In that case use multi-line exports:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%%</span><span class="n">pythran</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="c1">#pythran export my(bool,</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c1">#                  bool,</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c1">#                  bool,</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c1">#                  bool)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">my</span><span class="p">(</span><span class="n">ga</span><span class="p">,</span> <span class="n">bu</span><span class="p">,</span> <span class="n">zo</span><span class="p">,</span> <span class="n">meu</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">pass</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">my</span>
</pre></div>


<div class="highlight"><pre><span></span>&lt;function pythranized_91f76c58891b91073f8e4e4dae8d0989.my&gt;
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="nb">type</span><span class="p">(</span><span class="n">my</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span>
</pre></div>


<div class="highlight"><pre><span></span>NoneType
</pre></div>


<p>Default arguments are taken into account, but they must be exported explictely:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%%</span><span class="n">pythran</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c1">#pythran export pi_numpy_style_pythran_default(int)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c1">#pythran export pi_numpy_style_pythran_default()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">pi_numpy_style_pythran_default</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">step</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">n</span>
<span class="o">...</span>     <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">step</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mf">4.</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">pi_numpy_style_pythran_default</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span>3.2
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">pi_numpy_style_pythran_default</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span>3.1424259850010987
</pre></div>


<h1>Compilation of Numpy Expressions</h1>
<p>Pythran is well aware of high-level numpy expressions. Consider this function:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">vibr_energy</span><span class="p">(</span><span class="n">harmonic</span><span class="p">,</span> <span class="n">anharmonic</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">harmonic</span> <span class="o">*</span> <span class="n">i</span> <span class="o">-</span> <span class="n">anharmonic</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="n">dat0</span><span class="p">,</span> <span class="n">dat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">1000000</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">vibr_energy</span><span class="p">(</span><span class="n">dat0</span><span class="p">,</span> <span class="n">dat1</span><span class="p">,</span> <span class="mf">3.</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span>10 loops, best of 3: 25.7 ms per loop
</pre></div>


<p>A typical way to optimize it would be to use the <code>numexpr</code> package:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">numexpr</span> <span class="kn">as</span> <span class="nn">ne</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">vibr_energy_numexpr</span><span class="p">(</span><span class="n">harmonic</span><span class="p">,</span> <span class="n">anharmonic</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">ne</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="s1">&#39;exp(-harmonic * i - anharmonic * (i ** 2))&#39;</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">vibr_energy_numexpr</span><span class="p">(</span><span class="n">dat0</span><span class="p">,</span> <span class="n">dat1</span><span class="p">,</span> <span class="mf">3.</span><span class="p">)</span>  <span class="c1"># maybe ne has a cache?</span>
<span class="o">&gt;&gt;&gt;</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">vibr_energy_numexpr</span><span class="p">(</span><span class="n">dat0</span><span class="p">,</span> <span class="n">dat1</span><span class="p">,</span> <span class="mf">3.</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span>100 loops, best of 3: 9.82 ms per loop
</pre></div>


<p>Pythran implements (roughly) the same optimizations as <code>numexpr</code> does:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%%</span><span class="n">pythran</span> <span class="o">-</span><span class="n">DUSE_BOOST_SIMD</span> <span class="o">-</span><span class="n">march</span><span class="o">=</span><span class="n">native</span> <span class="o">-</span><span class="n">Ofast</span> <span class="o">-</span><span class="n">fopenmp</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c1">#pythran export vibr_energy_pythran(float[], float[], float)</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">vibr_energy_pythran</span><span class="p">(</span><span class="n">harmonic</span><span class="p">,</span> <span class="n">anharmonic</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
<span class="o">...</span>     
<span class="o">...</span>     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">harmonic</span> <span class="o">*</span> <span class="n">i</span> <span class="o">-</span> <span class="n">anharmonic</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">vibr_energy_pythran</span><span class="p">(</span><span class="n">dat0</span><span class="p">,</span> <span class="n">dat1</span><span class="p">,</span> <span class="mf">3.</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span>100 loops, best of 3: 4.87 ms per loop
</pre></div>


<p>Remember that Pythran can handle polymorphic code? Then let's try:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%%</span><span class="n">pythran</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c1">#pythran export vibr_energy_pythran(float[], float[], float)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c1">#pythran export vibr_energy_pythran(float[], float[], float[])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">vibr_energy_pythran</span><span class="p">(</span><span class="n">harmonic</span><span class="p">,</span> <span class="n">anharmonic</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">harmonic</span> <span class="o">*</span> <span class="n">i</span> <span class="o">-</span> <span class="n">anharmonic</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">vibr_energy_pythran</span><span class="p">(</span><span class="n">dat0</span><span class="p">,</span> <span class="n">dat1</span><span class="p">,</span> <span class="n">dat0</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span>100 loops, best of 3: 12.9 ms per loop
</pre></div>


<p>Broadcasting on the way!</p>
<h1>Using Pythran from the Command Line</h1>
<p>Pythran can be used without a Jupyter notebook! It requires you to</p>
<ol>
<li>Write your code to Pythranize into a seperate file;</li>
<li>Call the Pythran compiler.</li>
</ol>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%%</span><span class="nb">file</span> <span class="n">scrabble</span><span class="o">.</span><span class="n">py</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c1">#pythran export scrabble_score(str, str:int dict)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">scrabble_score</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">scoretable</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">word</span><span class="p">:</span>
<span class="o">...</span>         <span class="k">if</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">scoretable</span><span class="p">:</span>
<span class="o">...</span>             <span class="n">score</span> <span class="o">+=</span> <span class="n">scoretable</span><span class="p">[</span><span class="n">letter</span><span class="p">]</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">score</span>
<span class="o">...</span> 
</pre></div>


<div class="highlight"><pre><span></span>Writing scrabble.py
</pre></div>


<p>Using the package API, or simply <code>pythran scrabble.py</code></p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="err">!</span><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">pythran</span><span class="o">.</span><span class="n">run</span> <span class="o">-</span><span class="n">v</span> <span class="n">scrabble</span><span class="o">.</span><span class="n">py</span>
</pre></div>


<div class="highlight"><pre><span></span>[39mrunning build_ext[0m
[39mrunning build_src[0m
[39mbuild_src[0m
[39mbuilding extension &quot;scrabble&quot; sources[0m
[39mbuild_src: building npy-pkg config files[0m
[36mnew_compiler returns distutils.unixccompiler.UnixCCompiler[0m
[32mINFO    [0m [34mcustomize UnixCCompiler[0m
[39mcustomize UnixCCompiler using build_ext[0m
********************************************************************************
distutils.unixccompiler.UnixCCompiler
linker_exe    = [&#39;x86_64-linux-gnu-gcc&#39;, &#39;-pthread&#39;]
compiler_so   = [&#39;x86_64-linux-gnu-gcc&#39;, &#39;-pthread&#39;, &#39;-DNDEBUG&#39;, &#39;-g&#39;, &#39;-fwrapv&#39;, &#39;-O2&#39;, &#39;-Wall&#39;, &#39;-Wstrict-prototypes&#39;, &#39;-fno-strict-aliasing&#39;, &#39;-g&#39;, &#39;-O2&#39;, &#39;-fPIC&#39;]
archiver      = [&#39;x86_64-linux-gnu-gcc-ar&#39;, &#39;rc&#39;]
preprocessor  = [&#39;x86_64-linux-gnu-gcc&#39;, &#39;-pthread&#39;, &#39;-E&#39;]
linker_so     = [&#39;x86_64-linux-gnu-gcc&#39;, &#39;-pthread&#39;, &#39;-shared&#39;, &#39;-Wl,-O1&#39;, &#39;-Wl,-Bsymbolic-functions&#39;, &#39;-Wl,-z,relro&#39;, &#39;-fno-strict-aliasing&#39;, &#39;-DNDEBUG&#39;, &#39;-g&#39;, &#39;-fwrapv&#39;, &#39;-O2&#39;, &#39;-Wall&#39;, &#39;-Wstrict-prototypes&#39;, &#39;-Wdate-time&#39;, &#39;-D_FORTIFY_SOURCE=2&#39;, &#39;-g&#39;, &#39;-fstack-protector-strong&#39;, &#39;-Wformat&#39;, &#39;-Werror=format-security&#39;, &#39;-Wl,-z,relro&#39;, &#39;-g&#39;, &#39;-O2&#39;]
compiler_cxx  = [&#39;c++&#39;, &#39;-pthread&#39;]
ranlib        = None
compiler      = [&#39;x86_64-linux-gnu-gcc&#39;, &#39;-pthread&#39;, &#39;-DNDEBUG&#39;, &#39;-g&#39;, &#39;-fwrapv&#39;, &#39;-O2&#39;, &#39;-Wall&#39;, &#39;-Wstrict-prototypes&#39;, &#39;-fno-strict-aliasing&#39;, &#39;-g&#39;, &#39;-O2&#39;]
libraries     = []
library_dirs  = []
include_dirs  = [&#39;/usr/include/python2.7&#39;]
********************************************************************************
[36mnew_compiler returns distutils.unixccompiler.UnixCCompiler[0m
[32mINFO    [0m [34mcustomize UnixCCompiler[0m
[39mcustomize UnixCCompiler using build_ext[0m
********************************************************************************
distutils.unixccompiler.UnixCCompiler
linker_exe    = [&#39;x86_64-linux-gnu-gcc&#39;, &#39;-pthread&#39;]
compiler_so   = [&#39;x86_64-linux-gnu-gcc&#39;, &#39;-pthread&#39;, &#39;-DNDEBUG&#39;, &#39;-g&#39;, &#39;-fwrapv&#39;, &#39;-O2&#39;, &#39;-Wall&#39;, &#39;-fno-strict-aliasing&#39;, &#39;-g&#39;, &#39;-O2&#39;, &#39;-fPIC&#39;]
archiver      = [&#39;x86_64-linux-gnu-gcc-ar&#39;, &#39;rc&#39;]
preprocessor  = [&#39;x86_64-linux-gnu-gcc&#39;, &#39;-pthread&#39;, &#39;-E&#39;]
linker_so     = [&#39;x86_64-linux-gnu-gcc&#39;, &#39;-pthread&#39;, &#39;-shared&#39;, &#39;-Wl,-O1&#39;, &#39;-Wl,-Bsymbolic-functions&#39;, &#39;-Wl,-z,relro&#39;, &#39;-fno-strict-aliasing&#39;, &#39;-DNDEBUG&#39;, &#39;-g&#39;, &#39;-fwrapv&#39;, &#39;-O2&#39;, &#39;-Wall&#39;, &#39;-Wstrict-prototypes&#39;, &#39;-Wdate-time&#39;, &#39;-D_FORTIFY_SOURCE=2&#39;, &#39;-g&#39;, &#39;-fstack-protector-strong&#39;, &#39;-Wformat&#39;, &#39;-Werror=format-security&#39;, &#39;-Wl,-z,relro&#39;, &#39;-g&#39;, &#39;-O2&#39;]
compiler_cxx  = [&#39;c++&#39;, &#39;-pthread&#39;]
ranlib        = None
compiler      = [&#39;x86_64-linux-gnu-gcc&#39;, &#39;-pthread&#39;, &#39;-DNDEBUG&#39;, &#39;-g&#39;, &#39;-fwrapv&#39;, &#39;-O2&#39;, &#39;-Wall&#39;, &#39;-Wstrict-prototypes&#39;, &#39;-fno-strict-aliasing&#39;, &#39;-g&#39;, &#39;-O2&#39;]
libraries     = []
library_dirs  = []
include_dirs  = [&#39;/usr/include/python2.7&#39;]
********************************************************************************
[39mbuilding &#39;scrabble&#39; extension[0m
[39mcompiling C++ sources[0m
[39mC compiler: c++ -pthread -DNDEBUG -g -fwrapv -O2 -Wall -fno-strict-aliasing -g -O2 -fPIC
[0m
[39mcreating /tmp/tmpiXxCc3/tmp[0m
[39mcompile options: &#39;-DUSE_GMP -DENABLE_PYTHON_MODULE -I/home/sguelton/sources/pythran/pythran -I/home/sguelton/sources/pythran/pythran/pythonic/patch -I/home/sguelton/.venvs/pythran-demo/local/lib/python2.7/site-packages/numpy/core/include -I/usr/include/python2.7 -c&#39;
extra options: &#39;-std=c++11 -fno-math-errno -w -fwhole-program -fvisibility=hidden&#39;[0m
[39mc++: /tmp/tmpRIF8Kz.cpp[0m
[36mexec_command([&#39;c++&#39;, &#39;-pthread&#39;, &#39;-DNDEBUG&#39;, &#39;-g&#39;, &#39;-fwrapv&#39;, &#39;-O2&#39;, &#39;-Wall&#39;, &#39;-fno-strict-aliasing&#39;, &#39;-g&#39;, &#39;-O2&#39;, &#39;-fPIC&#39;, &#39;-DUSE_GMP&#39;, &#39;-DENABLE_PYTHON_MODULE&#39;, &#39;-I/home/sguelton/sources/pythran/pythran&#39;, &#39;-I/home/sguelton/sources/pythran/pythran/pythonic/patch&#39;, &#39;-I/home/sguelton/.venvs/pythran-demo/local/lib/python2.7/site-packages/numpy/core/include&#39;, &#39;-I/usr/include/python2.7&#39;, &#39;-c&#39;, &#39;/tmp/tmpRIF8Kz.cpp&#39;, &#39;-o&#39;, &#39;/tmp/tmpiXxCc3/tmp/tmpRIF8Kz.o&#39;, &#39;-std=c++11&#39;, &#39;-fno-math-errno&#39;, &#39;-w&#39;, &#39;-fwhole-program&#39;, &#39;-fvisibility=hidden&#39;],)[0m
[36mRetaining cwd: /home/sguelton/sources/pythran/notebooks[0m
[36m_preserve_environment([])[0m
[36m_update_environment(...)[0m
[36m_exec_command_posix(...)[0m
[36mRunning os.system(&#39;( c++ -pthread -DNDEBUG -g -fwrapv -O2 -Wall -fno-strict-aliasing -g -O2 -fPIC -DUSE_GMP -DENABLE_PYTHON_MODULE -I/home/sguelton/sources/pythran/pythran -I/home/sguelton/sources/pythran/pythran/pythonic/patch -I/home/sguelton/.venvs/pythran-demo/local/lib/python2.7/site-packages/numpy/core/include -I/usr/include/python2.7 -c /tmp/tmpRIF8Kz.cpp -o /tmp/tmpiXxCc3/tmp/tmpRIF8Kz.o -std=c++11 -fno-math-errno -w -fwhole-program -fvisibility=hidden ; echo $? &gt; /tmp/tmpkJNNfR/XwPT61 ) 2&gt;&amp;1 | tee /tmp/tmpkJNNfR/xJbGUl &#39;)[0m
[36m_update_environment(...)[0m
[39mc++ -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,-z,relro -fno-strict-aliasing -DNDEBUG -g -fwrapv -O2 -Wall -Wstrict-prototypes -Wdate-time -D_FORTIFY_SOURCE=2 -g -fstack-protector-strong -Wformat -Werror=format-security -Wl,-z,relro -g -O2 /tmp/tmpiXxCc3/tmp/tmpRIF8Kz.o -lgmp -lgmpxx -lcblas -lblas -o /tmp/tmpsa8TH1/scrabble.so -fvisibility=hidden -Wl,-strip-all[0m
[36mexec_command([&#39;c++&#39;, &#39;-pthread&#39;, &#39;-shared&#39;, &#39;-Wl,-O1&#39;, &#39;-Wl,-Bsymbolic-functions&#39;, &#39;-Wl,-z,relro&#39;, &#39;-fno-strict-aliasing&#39;, &#39;-DNDEBUG&#39;, &#39;-g&#39;, &#39;-fwrapv&#39;, &#39;-O2&#39;, &#39;-Wall&#39;, &#39;-Wstrict-prototypes&#39;, &#39;-Wdate-time&#39;, &#39;-D_FORTIFY_SOURCE=2&#39;, &#39;-g&#39;, &#39;-fstack-protector-strong&#39;, &#39;-Wformat&#39;, &#39;-Werror=format-security&#39;, &#39;-Wl,-z,relro&#39;, &#39;-g&#39;, &#39;-O2&#39;, &#39;/tmp/tmpiXxCc3/tmp/tmpRIF8Kz.o&#39;, &#39;-lgmp&#39;, &#39;-lgmpxx&#39;, &#39;-lcblas&#39;, &#39;-lblas&#39;, &#39;-o&#39;, &#39;/tmp/tmpsa8TH1/scrabble.so&#39;, &#39;-fvisibility=hidden&#39;, &#39;-Wl,-strip-all&#39;],)[0m
[36mRetaining cwd: /home/sguelton/sources/pythran/notebooks[0m
[36m_preserve_environment([])[0m
[36m_update_environment(...)[0m
[36m_exec_command_posix(...)[0m
[36mRunning os.system(&#39;( c++ -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,-z,relro -fno-strict-aliasing -DNDEBUG -g -fwrapv -O2 -Wall -Wstrict-prototypes -Wdate-time -D_FORTIFY_SOURCE=2 -g -fstack-protector-strong -Wformat -Werror=format-security -Wl,-z,relro -g -O2 /tmp/tmpiXxCc3/tmp/tmpRIF8Kz.o -lgmp -lgmpxx -lcblas -lblas -o /tmp/tmpsa8TH1/scrabble.so -fvisibility=hidden -Wl,-strip-all ; echo $? &gt; /tmp/tmpkJNNfR/KjbDFo ) 2&gt;&amp;1 | tee /tmp/tmpkJNNfR/LHI7ms &#39;)[0m
[36m_update_environment(...)[0m
[32mINFO    [0m [34mGenerated module: scrabble[0m
[32mINFO    [0m [34mOutput: /home/sguelton/sources/pythran/notebooks/scrabble.so[0m
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">scrabble</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">scrabble</span><span class="o">.</span><span class="n">__file__</span>
</pre></div>


<div class="highlight"><pre><span></span>&#39;scrabble.so&#39;
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">scrabble</span><span class="o">.</span><span class="n">scrabble_score</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;h&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
</pre></div>


<div class="highlight"><pre><span></span>8
</pre></div>


<h1>Using Pythran with distutils</h1>
<p>Pythran provides some facilities for distutils integration, in the form of a <code>PythranExtension</code>:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%%</span><span class="nb">file</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">distutils.core</span> <span class="kn">import</span> <span class="n">Extension</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">dist</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="n">dist</span><span class="o">.</span><span class="n">Distribution</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">setup_requires</span><span class="o">=</span><span class="s1">&#39;pythran&#39;</span><span class="p">))</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">pythran</span> <span class="kn">import</span> <span class="n">PythranExtension</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">module1</span> <span class="o">=</span> <span class="n">PythranExtension</span><span class="p">(</span><span class="s1">&#39;demo&#39;</span><span class="p">,</span> <span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;scrabble.py&#39;</span><span class="p">])</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="n">setup</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;demo&#39;</span><span class="p">,</span>
<span class="o">...</span>       <span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;1.0&#39;</span><span class="p">,</span>
<span class="o">...</span>       <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;This is a demo package&#39;</span><span class="p">,</span>
<span class="o">...</span>       <span class="n">ext_modules</span> <span class="o">=</span> <span class="p">[</span><span class="n">module1</span><span class="p">])</span>
<span class="o">...</span> 
</pre></div>


<div class="highlight"><pre><span></span>Writing setup.py
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="err">!</span><span class="n">python</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">build</span> <span class="o">-</span><span class="n">v</span>
</pre></div>


<div class="highlight"><pre><span></span>[39mrunning build[0m
[39mrunning build_ext[0m
[39mbuilding &#39;demo&#39; extension[0m
[39mC compiler: x86_64-linux-gnu-gcc -pthread -DNDEBUG -g -fwrapv -O2 -Wall -Wstrict-prototypes -fno-strict-aliasing -g -O2 -fPIC
[0m
[39mcreating build[0m
[39mcreating build/temp.linux-x86_64-2.7[0m
[39mcompile options: &#39;-DUSE_GMP -DENABLE_PYTHON_MODULE -I/home/sguelton/sources/pythran/pythran -I/home/sguelton/sources/pythran/pythran/pythonic/patch -I/usr/include/python2.7 -c&#39;
extra options: &#39;-std=c++11 -fno-math-errno -w -fwhole-program -fvisibility=hidden&#39;[0m
[39mx86_64-linux-gnu-gcc: scrabble.cpp[0m
cc1plus: warning: command line option ‚Äò-Wstrict-prototypes‚Äô is valid for C/ObjC but not for C++
[39mcreating build/lib.linux-x86_64-2.7[0m
[39mc++ -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,-z,relro -fno-strict-aliasing -DNDEBUG -g -fwrapv -O2 -Wall -Wstrict-prototypes -Wdate-time -D_FORTIFY_SOURCE=2 -g -fstack-protector-strong -Wformat -Werror=format-security -Wl,-z,relro -g -O2 build/temp.linux-x86_64-2.7/scrabble.o -lgmp -lgmpxx -lcblas -lblas -o build/lib.linux-x86_64-2.7/demo.so -fvisibility=hidden -Wl,-strip-all[0m
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="err">!</span><span class="n">python</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">sdist</span>
</pre></div>


<div class="highlight"><pre><span></span>[39mrunning sdist[0m
[39mrunning egg_info[0m
[39mwriting demo.egg-info/PKG-INFO[0m
[39mwriting top-level names to demo.egg-info/top_level.txt[0m
[39mwriting dependency_links to demo.egg-info/dependency_links.txt[0m
[39mreading manifest file &#39;demo.egg-info/SOURCES.txt&#39;[0m
[39mwriting manifest file &#39;demo.egg-info/SOURCES.txt&#39;[0m
[31mwarning: sdist: standard file not found: should have one of README, README.rst, README.txt
[0m
[39mrunning check[0m
[31mwarning: check: missing required meta-data: url
[0m
[31mwarning: check: missing meta-data: either (author and author_email) or (maintainer and maintainer_email) must be supplied
[0m
[39mcreating demo-1.0[0m
[39mcreating demo-1.0/demo.egg-info[0m
[39mmaking hard links in demo-1.0...[0m
[39mhard linking scrabble.cpp -&gt; demo-1.0[0m
[39mhard linking setup.py -&gt; demo-1.0[0m
[39mhard linking demo.egg-info/PKG-INFO -&gt; demo-1.0/demo.egg-info[0m
[39mhard linking demo.egg-info/SOURCES.txt -&gt; demo-1.0/demo.egg-info[0m
[39mhard linking demo.egg-info/dependency_links.txt -&gt; demo-1.0/demo.egg-info[0m
[39mhard linking demo.egg-info/top_level.txt -&gt; demo-1.0/demo.egg-info[0m
[39mWriting demo-1.0/setup.cfg[0m
[39mcreating dist[0m
[39mCreating tar archive[0m
[39mremoving &#39;demo-1.0&#39; (and everything under it)[0m
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="err">!</span><span class="n">tar</span> <span class="n">tzf</span> <span class="n">dist</span><span class="o">/</span><span class="n">demo</span><span class="o">-</span><span class="mf">1.0</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
</pre></div>


<div class="highlight"><pre><span></span>demo-1.0/
demo-1.0/PKG-INFO
demo-1.0/scrabble.cpp
demo-1.0/demo.egg-info/
demo-1.0/demo.egg-info/PKG-INFO
demo-1.0/demo.egg-info/SOURCES.txt
demo-1.0/demo.egg-info/dependency_links.txt
demo-1.0/demo.egg-info/top_level.txt
demo-1.0/setup.py
demo-1.0/setup.cfg
</pre></div>


<h1>Getting Help</h1>
<ul>
<li>GitHub: https://github.com/serge-sans-paille/pythran</li>
<li>Mailing list: http://www.freelists.org/list/pythran</li>
<li>IRC: #pythran on FreeNode</li>
<li>StackOverflow: http://stackoverflow.com/questions/tagged/pythran</li>
</ul>
<h1>Misc</h1>
<p>Things you probably don't want to know, but they were fun to implement, so let's talk about them anyway :-)</p>
<h2>Functions as regular values</h2>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%%</span><span class="n">pythran</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c1">#pythran export modify(int, str)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">actions</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;increase&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
<span class="o">...</span>            <span class="s2">&quot;decrease&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">modify</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">what</span> <span class="o">=</span> <span class="n">actions</span><span class="p">[</span><span class="n">action</span><span class="p">]</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">what</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">modify</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;increase&quot;</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span>2
</pre></div>


<p>Passing functions in and out is not supported though.</p>
<h2>Big Numbers</h2>
<p>Not widely supported, but it works for simple examples.</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%%</span><span class="n">pythran</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c1">#pythran export factorize_naive(long)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">factorize_naive</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
<span class="o">...</span>         <span class="k">return</span> <span class="p">[]</span>
<span class="o">...</span>     
<span class="o">...</span>     <span class="n">factors</span> <span class="o">=</span> <span class="p">[]</span>
<span class="o">...</span>     
<span class="o">...</span>     <span class="n">p</span> <span class="o">=</span> <span class="il">2L</span>
<span class="o">...</span> 
<span class="o">...</span>     <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
<span class="o">...</span>         <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="o">...</span>             <span class="k">return</span> <span class="n">factors</span>
<span class="o">...</span> 
<span class="o">...</span>         <span class="n">r</span> <span class="o">=</span> <span class="n">n</span> <span class="o">%</span> <span class="n">p</span>
<span class="o">...</span>         <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="o">...</span>             <span class="n">factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="o">...</span>             <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="n">p</span>
<span class="o">...</span>         <span class="k">elif</span> <span class="n">p</span> <span class="o">*</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">:</span>
<span class="o">...</span>             <span class="n">factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="o">...</span>             <span class="k">return</span> <span class="n">factors</span>
<span class="o">...</span>         <span class="k">elif</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
<span class="o">...</span>             <span class="c1"># Advance in steps of 2 over odd numbers</span>
<span class="o">...</span>             <span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span>
<span class="o">...</span>         <span class="k">else</span><span class="p">:</span>
<span class="o">...</span>             <span class="c1"># If p == 2, get to 3</span>
<span class="o">...</span>             <span class="n">p</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="o">...</span>     <span class="k">assert</span> <span class="bp">False</span><span class="p">,</span> <span class="s2">&quot;unreachable&quot;</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">factorize_naive</span><span class="p">(</span><span class="il">3241618756762348687L</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span>1 loop, best of 3: 2 s per loop
</pre></div>


<h3>Cleanup before you leave the room ;-)</h3>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="err">!</span><span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="n">build</span> <span class="n">dist</span> <span class="n">scrabble</span><span class="o">.</span><span class="n">py</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">scrabble</span><span class="o">.</span><span class="n">so</span> <span class="c1"># cleanup</span>
</pre></div>
                </div><!-- /.entry-content -->
        </article>
</section>
        </div><!--/span-->

                <div class="span3 well sidebar-nav" id="sidebar">
<ul class="nav nav-list">
<li class="nav-header"><h4><i class="icon-external-link"></i>blogroll</h4></li>
    <li><a href="http://pythonhosted.org/pythran"><i class="icon-external-link"></i>Pythran Doc</a></li>
    <li><a href="https://pypi.python.org/pypi/pythran"><i class="icon-external-link"></i>Pythran on PyPI</a></li>
<li class="nav-header"><h4><i class="icon-home icon-large"></i> social</h4></li>
<li><a href="./" rel="alternate"><i class="icon-bookmark icon-large"></i>atom feed</a></li>
    <li><a href="https://github.com/serge-sans-paille/pythran"><i class="icon-github-sign icon-large"></i>github</a></li>

<li class="nav-header"><h4><i class="icon-folder-close icon-large"></i>Categories</h4></li>
<li>
<a href="./category/benchmark.html">
    <i class="icon-folder-open icon-large"></i>benchmark
</a>
</li>
<li>
<a href="./category/compilation.html">
    <i class="icon-folder-open icon-large"></i>compilation
</a>
</li>
<li>
<a href="./category/examples.html">
    <i class="icon-folder-open icon-large"></i>examples
</a>
</li>
<li>
<a href="./category/optimisation.html">
    <i class="icon-folder-open icon-large"></i>optimisation
</a>
</li>
<li>
<a href="./category/release.html">
    <i class="icon-folder-open icon-large"></i>release
</a>
</li>

<li class="nav-header"><h4><i class="icon-tags icon-large"></i>Tags</h4></li>


</ul>        </div><!--/.well -->

      </div><!--/row-->

      <hr>

      <footer>
        <address id="about">
                Proudly powered by <a href="http://pelican.notmyidea.org/">Pelican <i class="icon-external-link"></i></a>,
                                which takes great advantage of <a href="http://python.org">Python <i class="icon-external-link"></i></a>.
        </address><!-- /#about -->

        <p>The theme is from <a href="http://twitter.github.com/bootstrap/">Bootstrap from Twitter <i class="icon-external-link"></i></a>,
                   and <a href="http://fortawesome.github.com/Font-Awesome/">Font-Awesome <i class="icon-external-link"></i></a>, thanks!</p>
      </footer>

    </div><!--/.fluid-container-->



    <!-- Le javascript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="./theme/js/jquery-1.7.2.min.js"></script>
    <script src="./theme/js/bootstrap.min.js"></script>
  </body>
</html>