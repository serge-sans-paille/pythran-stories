<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Pythran stories - Compiler Flags</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css"/>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda"/>
        <link rel="stylesheet" type="text/css" href="./theme/css/main.css"/>
            <link href="http://serge-sans-paille.github.io/pythran-stories/
feeds/all.atom.xml"
                  type="application/atom+xml" rel="alternate" title="Pythran stories Atom Feed"/>

</head>
<body>
<style>.github-corner:hover .octo-arm {
    animation: octocat-wave 560ms ease-in-out
}
@keyframes octocat-wave {
    0%, 100% {
        transform: rotate(0)
    }
    20%, 60% {
        transform: rotate(-25deg)
    }
    40%, 80% {
        transform: rotate(10deg)
    }
}
@media (max-width: 500px) {
    .github-corner:hover .octo-arm {
        animation: none
    }

    .github-corner .octo-arm {
        animation: octocat-wave 560ms ease-in-out
    }
}</style><div id="container">
    <header>
        <h1><a href="./">Pythran stories</a></h1>
            <ul class="social-media">
                    <li><a href="https://github.com/serge-sans-paille/pythran"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a></li>
                    <li><a href="http://serge-sans-paille.github.io/pythran-stories/
feeds/all.atom.xml"
                           type="application/atom+xml" rel="alternate"><i class="fa fa-rss fa-lg"
                                                                          aria-hidden="true"></i></a></li>
            </ul>
        <p><em></em></p>
    </header>
    <nav>
        <ul>
                    <li><a href="./category/benchmark.html"> benchmark </a></li>
                    <li><a                         class="active" href="./category/compilation.html"> compilation </a></li>
                    <li><a href="./category/engineering.html"> engineering </a></li>
                    <li><a href="./category/examples.html"> examples </a></li>
                    <li><a href="./category/optimisation.html"> optimisation </a></li>
                    <li><a href="./category/release.html"> release </a></li>
        </ul>
    </nav>
<main>
    <article>
        <h1>Compiler Flags</h1>
        
        <aside>
            <ul>
                <li>
                    <time datetime="2016-03-29 00:00:00+02:00">Mar 29, 2016</time>
                </li>
                <li>
                    Categories:
                    <a href="./category/compilation.html"><em>compilation</em></a>
                </li>
                </li>
            </ul>
        </aside>
        <div class="section" id="when-size-matters">
<h2>When Size Matters</h2>
<p>Everything started a few days ago with a Pythran user complaining about the
size of the binaries generated by Pythran. In essence, take the following code
<cite>cda.py</cite>:</p>
<div class="highlight"><pre><span></span><span class="c1">#pythran export closest_distance_arrays(float, float, float[], float[])</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="k">def</span> <span class="nf">closest_distance_arrays</span> <span class="p">(</span><span class="n">lat1</span><span class="p">,</span> <span class="n">long1</span><span class="p">,</span> <span class="n">latitudes</span><span class="p">,</span> <span class="n">longitudes</span><span class="p">):</span>
    <span class="n">degrees_to_radians</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.0</span>
    <span class="n">phi1</span> <span class="o">=</span> <span class="p">(</span><span class="mf">90.0</span> <span class="o">-</span> <span class="n">lat1</span><span class="p">)</span><span class="o">*</span><span class="n">degrees_to_radians</span>
    <span class="n">phi2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">90.0</span> <span class="o">-</span> <span class="n">latitudes</span><span class="p">)</span><span class="o">*</span><span class="n">degrees_to_radians</span>
    <span class="n">theta1</span> <span class="o">=</span> <span class="n">long1</span><span class="o">*</span><span class="n">degrees_to_radians</span>
    <span class="n">theta2</span> <span class="o">=</span> <span class="n">longitudes</span><span class="o">*</span><span class="n">degrees_to_radians</span>
    <span class="n">cos</span> <span class="o">=</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta1</span> <span class="o">-</span> <span class="n">theta2</span><span class="p">)</span> <span class="o">+</span>
           <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi2</span><span class="p">))</span>
    <span class="n">arc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span> <span class="n">cos</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">arc</span><span class="p">),</span> <span class="n">arc</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</pre></div>
<p>It doesn't even weight a kilobyte, and when benchmarked, it runs in a few milliseconds:</p>
<div class="highlight"><pre><span></span>&gt;<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>timeit<span class="w"> </span>-s<span class="w"> </span><span class="s1">&#39;import numpy as np; n = 20000 ; lat, lon = np.random.rand(n), np.random.rand(n); x,y = np.random.rand(), np.random.rand(); from cda import closest_distance_arrays&#39;</span><span class="w"> </span><span class="s1">&#39;closest_distance_arrays(x,y,lat, lon)&#39;</span>
<span class="m">100</span><span class="w"> </span>loops,<span class="w"> </span>best<span class="w"> </span>of<span class="w"> </span><span class="m">3</span>:<span class="w"> </span><span class="m">1</span>.95<span class="w"> </span>msec<span class="w"> </span>per<span class="w"> </span>loop
</pre></div>
<p>Thanks to the <tt class="docutils literal">#pythran export</tt> annotation, Pythran can turn it into a native
library that runs slightly faster than the Python version:</p>
<div class="highlight"><pre><span></span>&gt;<span class="w"> </span>pythran<span class="w"> </span>cda.py
&gt;<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>timeit<span class="w"> </span>-s<span class="w"> </span><span class="s1">&#39;import numpy as np; n = 20000 ; lat, lon = np.random.rand(n), np.random.rand(n); x,y = np.random.rand(), np.random.rand(); from cda import closest_distance_arrays&#39;</span><span class="w"> </span><span class="s1">&#39;closest_distance_arrays(x,y,lat, lon)&#39;</span>
<span class="m">1000</span><span class="w"> </span>loops,<span class="w"> </span>best<span class="w"> </span>of<span class="w"> </span><span class="m">3</span>:<span class="w"> </span><span class="m">1</span>.17<span class="w"> </span>msec<span class="w"> </span>per<span class="w"> </span>loop
</pre></div>
<p>It is, however, a very big binary:</p>
<div class="highlight"><pre><span></span>&gt;<span class="w"> </span>ls<span class="w"> </span>-lh<span class="w"> </span>cda.so
-rwxr-xr-x<span class="w"> </span><span class="m">1</span><span class="w"> </span>sguelton<span class="w"> </span>sguelton<span class="w"> </span><span class="m">1</span>.3M<span class="w"> </span>Mar<span class="w"> </span><span class="m">29</span><span class="w"> </span><span class="m">18</span>:10<span class="w"> </span>cda.so*
</pre></div>
<p>Who wants to multiply the binary size by <tt class="docutils literal">2e3</tt> to get less than a <tt class="docutils literal">x2</tt> speedup?</p>
</div>
<div class="section" id="the-culprits-debug-informations">
<h2>The culprits: Debug Informations</h2>
<p>One can call Pythran with the <tt class="docutils literal"><span class="pre">-v</span></tt> flag to inspect part of its internal,
especially the C++ compiler call done to perform object code generation and
linking:</p>
<div class="highlight"><pre><span></span>&gt;<span class="w"> </span>pythran<span class="w"> </span>cda.py<span class="w"> </span>-v
running<span class="w"> </span>build_ext
running<span class="w"> </span>build_src
build_src
building<span class="w"> </span>extension<span class="w"> </span><span class="s2">&quot;cda&quot;</span><span class="w"> </span>sources
build_src:<span class="w"> </span>building<span class="w"> </span>npy-pkg<span class="w"> </span>config<span class="w"> </span>files
new_compiler<span class="w"> </span>returns<span class="w"> </span>distutils.unixccompiler.UnixCCompiler
INFO<span class="w">     </span>customize<span class="w"> </span>UnixCCompiler
customize<span class="w"> </span>UnixCCompiler<span class="w"> </span>using<span class="w"> </span>build_ext
********************************************************************************
distutils.unixccompiler.UnixCCompiler
<span class="nv">linker_exe</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="s1">&#39;gcc&#39;</span><span class="o">]</span>
<span class="nv">compiler_so</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="s1">&#39;gcc&#39;</span>,<span class="w"> </span><span class="s1">&#39;-DNDEBUG&#39;</span>,<span class="w"> </span><span class="s1">&#39;-g&#39;</span>,<span class="w"> </span><span class="s1">&#39;-fwrapv&#39;</span>,<span class="w"> </span><span class="s1">&#39;-O2&#39;</span>,<span class="w"> </span><span class="s1">&#39;-Wall&#39;</span>,<span class="w"> </span><span class="s1">&#39;-Wstrict-prototypes&#39;</span>,<span class="w"> </span><span class="s1">&#39;-fno-strict-aliasing&#39;</span>,<span class="w"> </span><span class="s1">&#39;-g&#39;</span>,<span class="w"> </span><span class="s1">&#39;-O2&#39;</span>,<span class="w"> </span><span class="s1">&#39;-fPIC&#39;</span><span class="o">]</span>
<span class="nv">archiver</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="s1">&#39;x86_64-linux-gnu-gcc-ar&#39;</span>,<span class="w"> </span><span class="s1">&#39;rc&#39;</span><span class="o">]</span>
<span class="nv">preprocessor</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="s1">&#39;gcc&#39;</span>,<span class="w"> </span><span class="s1">&#39;-E&#39;</span><span class="o">]</span>
<span class="nv">linker_so</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="s1">&#39;x86_64-linux-gnu-gcc&#39;</span>,<span class="w"> </span><span class="s1">&#39;-pthread&#39;</span>,<span class="w"> </span><span class="s1">&#39;-shared&#39;</span>,<span class="w"> </span><span class="s1">&#39;-Wl,-O1&#39;</span>,<span class="w"> </span><span class="s1">&#39;-Wl,-Bsymbolic-functions&#39;</span>,<span class="w"> </span><span class="s1">&#39;-Wl,-z,relro&#39;</span>,<span class="w"> </span><span class="s1">&#39;-fno-strict-aliasing&#39;</span>,<span class="w"> </span><span class="s1">&#39;-DNDEBUG&#39;</span>,<span class="w"> </span><span class="s1">&#39;-g&#39;</span>,<span class="w"> </span><span class="s1">&#39;-fwrapv&#39;</span>,<span class="w"> </span><span class="s1">&#39;-O2&#39;</span>,<span class="w"> </span><span class="s1">&#39;-Wall&#39;</span>,<span class="w"> </span><span class="s1">&#39;-Wstrict-prototypes&#39;</span>,<span class="w"> </span><span class="s1">&#39;-Wdate-time&#39;</span>,<span class="w"> </span><span class="s1">&#39;-D_FORTIFY_SOURCE=2&#39;</span>,<span class="w"> </span><span class="s1">&#39;-g&#39;</span>,<span class="w"> </span><span class="s1">&#39;-fstack-protector-strong&#39;</span>,<span class="w"> </span><span class="s1">&#39;-Wformat&#39;</span>,<span class="w"> </span><span class="s1">&#39;-Werror=format-security&#39;</span>,<span class="w"> </span><span class="s1">&#39;-Wl,-z,relro&#39;</span>,<span class="w"> </span><span class="s1">&#39;-g&#39;</span>,<span class="w"> </span><span class="s1">&#39;-O2&#39;</span><span class="o">]</span>
<span class="nv">compiler_cxx</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="s1">&#39;g++&#39;</span><span class="o">]</span>
<span class="nv">ranlib</span><span class="w">        </span><span class="o">=</span><span class="w"> </span>None
<span class="nv">compiler</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="s1">&#39;gcc&#39;</span>,<span class="w"> </span><span class="s1">&#39;-DNDEBUG&#39;</span>,<span class="w"> </span><span class="s1">&#39;-g&#39;</span>,<span class="w"> </span><span class="s1">&#39;-fwrapv&#39;</span>,<span class="w"> </span><span class="s1">&#39;-O2&#39;</span>,<span class="w"> </span><span class="s1">&#39;-Wall&#39;</span>,<span class="w"> </span><span class="s1">&#39;-Wstrict-prototypes&#39;</span>,<span class="w"> </span><span class="s1">&#39;-fno-strict-aliasing&#39;</span>,<span class="w"> </span><span class="s1">&#39;-g&#39;</span>,<span class="w"> </span><span class="s1">&#39;-O2&#39;</span><span class="o">]</span>
<span class="nv">libraries</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="o">[]</span>
<span class="nv">library_dirs</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="o">[]</span>
<span class="nv">include_dirs</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="s1">&#39;/usr/include/python2.7&#39;</span><span class="o">]</span>
<span class="o">[</span>...<span class="o">]</span>
INFO<span class="w">     </span>Generated<span class="w"> </span>module:<span class="w"> </span>cda
INFO<span class="w">     </span>Output:<span class="w"> </span>/home/sguelton/sources/pythran/cda.so
</pre></div>
<p>That's a pretty long trace, but that's what verbose mode is for. The
enlightened reader noticed that we use <tt class="docutils literal">distutils</tt> under the hood to abstract
the compiler calls, and that's why we're getting some funky compiler flags like
<tt class="docutils literal"><span class="pre">-g</span> <span class="pre">-fwrapv</span> <span class="pre">-O2</span> <span class="pre">-Wall</span> <span class="pre">-fno-strict-aliasing</span> <span class="pre">-g</span> <span class="pre">-O2</span> <span class="pre">-fPIC</span></tt> or even funkier
<tt class="docutils literal"><span class="pre">-fstack-protector-strong</span> <span class="pre">-Wformat</span> <span class="pre">-Werror=format-security</span> <span class="pre">-Wl,-z,relro</span></tt>.
That's the default for native python extensions on my distrib. Funny enough the
last ones are hardening flags used to improve the security of the binary and I
wrote a (passionating) article about it for Quarkslab <a class="footnote-reference" href="#footnote-1" id="footnote-reference-1">[0]</a>.</p>
<p>It turns out <tt class="docutils literal"><span class="pre">-g</span></tt> (and C++) is responsible for the fat binary: if we simply
strip the binary, we get back to a decent size:</p>
<div class="highlight"><pre><span></span>&gt;<span class="w"> </span>strip<span class="w"> </span>cda.so
&gt;<span class="w"> </span>ls<span class="w"> </span>-lh<span class="w"> </span>cda.so
-rwxr-xr-x<span class="w"> </span><span class="m">1</span><span class="w"> </span>sguelton<span class="w"> </span>sguelton<span class="w"> </span>151K<span class="w"> </span>Mar<span class="w"> </span><span class="m">29</span><span class="w"> </span><span class="m">18</span>:26<span class="w"> </span>cda.so
</pre></div>
<p>As Pythran users generally don't want the debug info on the generated native
code, we chose to strip them by default, using the linker flag
<tt class="docutils literal"><span class="pre">-Wl,-strip-all</span></tt> that removes all symbol informations, including debug
symbols.</p>
</div>
<div class="section" id="a-step-further-default-symbol-visibility">
<h2>A Step further: Default Symbol visibility</h2>
<p>While we're at it, let's call <tt class="docutils literal">nm</tt> to check if any symbol remains in the
binary. After all, the Python interpreter still needs some of them to load the
native extension!</p>
<div class="highlight"><pre><span></span>&gt;<span class="w"> </span>nm<span class="w"> </span>-C<span class="w"> </span>-D<span class="w"> </span>cda.so
<span class="o">[</span>...<span class="o">]</span><span class="w"> </span>skipping<span class="w"> </span>&gt;<span class="w"> </span><span class="m">900</span><span class="w"> </span>entries
000000000001ed00<span class="w"> </span>u<span class="w"> </span>nt2::ext::implement&lt;nt2::tag::rem_pio2_<span class="w"> </span><span class="o">(</span>boost::dispatch::meta::scalar_&lt;boost::dispatch::meta::double_&lt;double&gt;<span class="w"> </span>&gt;,<span class="w"> </span>boost::dispatch::meta::scalar_&lt;boost::dispatch::meta::double_&lt;double&gt;<span class="w"> </span>&gt;,<span class="w"> </span>boost::dispatch::meta::scalar_&lt;boost::dispatch::meta::double_&lt;double&gt;<span class="w"> </span>&gt;<span class="o">)</span>,<span class="w"> </span>boost::dispatch::tag::cpu_,<span class="w"> </span>void&gt;::__kernel_rem_pio2<span class="o">(</span>double*,<span class="w"> </span>double*,<span class="w"> </span>int,<span class="w"> </span>int,<span class="w"> </span>int,<span class="w"> </span>int<span class="w"> </span>const*<span class="o">)</span>::PIo2
000000000001edc0<span class="w"> </span>u<span class="w"> </span>nt2::ext::implement&lt;nt2::tag::rem_pio2_<span class="w"> </span><span class="o">(</span>boost::dispatch::meta::scalar_&lt;boost::dispatch::meta::double_&lt;double&gt;<span class="w"> </span>&gt;,<span class="w"> </span>boost::dispatch::meta::scalar_&lt;boost::dispatch::meta::double_&lt;double&gt;<span class="w"> </span>&gt;,<span class="w"> </span>boost::dispatch::meta::scalar_&lt;boost::dispatch::meta::double_&lt;double&gt;<span class="w"> </span>&gt;<span class="o">)</span>,<span class="w"> </span>boost::dispatch::tag::cpu_,<span class="w"> </span>void&gt;::__ieee754_rem_pio2<span class="o">(</span>double,<span class="w"> </span>double*<span class="o">)</span>::two_over_pi
000000000001ed40<span class="w"> </span>u<span class="w"> </span>nt2::ext::implement&lt;nt2::tag::rem_pio2_<span class="w"> </span><span class="o">(</span>boost::dispatch::meta::scalar_&lt;boost::dispatch::meta::double_&lt;double&gt;<span class="w"> </span>&gt;,<span class="w"> </span>boost::dispatch::meta::scalar_&lt;boost::dispatch::meta::double_&lt;double&gt;<span class="w"> </span>&gt;,<span class="w"> </span>boost::dispatch::meta::scalar_&lt;boost::dispatch::meta::double_&lt;double&gt;<span class="w"> </span>&gt;<span class="o">)</span>,<span class="w"> </span>boost::dispatch::tag::cpu_,<span class="w"> </span>void&gt;::__ieee754_rem_pio2<span class="o">(</span>double,<span class="w"> </span>double*<span class="o">)</span>::npio2_hw
</pre></div>
<p>I can tell you Python is <em>not</em> using nt2 dispatch mechanism to load native
extensions. Again, the default compiler settings are responsible for this
noise, and the relevant compiler flag is <tt class="docutils literal"><span class="pre">-fvisibility=hidden</span></tt> that tells the
compiler than only the functions flagged with a special attribute are part of
the external ABI, the other ones are not exported. As Python uses a single
entry point to load Pythran modules, namely <tt class="docutils literal">PyInit_cda</tt> for Python3 modules
and <tt class="docutils literal">initcda</tt> for Python2 modules <a class="footnote-reference" href="#footnote-2" id="footnote-reference-2">[1]</a>, one can add the <tt class="docutils literal">__attribute__
<span class="pre">((visibility(&quot;default&quot;)))</span></tt> on this symbol and it will be the only exported
one. This slightly impacts the code size, may decrease loading time and
eventually gives the compiler more optimization opportunities, but nothing
significant there (131K), apart the pleasure of generating cleaner binaries.
That's also going to be the default for next Pythran version.</p>
</div>
<div class="section" id="out-of-chance-getting-faster-binaries">
<h2>Out of chance: getting faster binaries</h2>
<p>In the (huge) info pages of GCC, near the doc of <tt class="docutils literal"><span class="pre">-fvisibility=hidden</span></tt>,
there's this (GCC only) compiler flag, <tt class="docutils literal"><span class="pre">-fwhole-program</span></tt> that implements some
kind of Link Time Optimization, in the sense that it tells the compiler to
consider the current compilation unit (or code) as a whole program. As
specified in the GCC man page, &quot;All public functions and variables with the
exception of &quot;main&quot; and those merged by attribute &quot;externally_visible&quot; become
static functions and in effect are optimized more aggressively by
interprocedural optimizers.&quot;, which basically means that every function is
considered static except for &quot;main&quot; and the ones that are explicitly told not
to be.  This allows the compiler for instance to remove functions that are
always inlined, and thus win space. So we flag the <tt class="docutils literal">initcda</tt> function with
<tt class="docutils literal">__attribute__ ((externally_visible))</tt>. That sounds a bit redundant to me
with the visibility attribute, but it turns out this triggers abunch of
different optimization path that gives us a significantly smaller binary, that
runs slightly faster:</p>
<div class="highlight"><pre><span></span>&gt;<span class="w"> </span>pythran<span class="w"> </span>cda.py<span class="w"> </span>-fvisibility<span class="o">=</span>hidden<span class="w"> </span>-fwhole-program<span class="w"> </span>-Wl,-strip-all
&gt;<span class="w"> </span>ls<span class="w"> </span>-lh<span class="w"> </span>cda.so
-rwxr-xr-x<span class="w"> </span><span class="m">1</span><span class="w"> </span>sguelton<span class="w"> </span>sguelton<span class="w"> </span>31K<span class="w"> </span>Mar<span class="w"> </span><span class="m">29</span><span class="w"> </span><span class="m">18</span>:52<span class="w"> </span>cda.so*
&gt;<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>timeit<span class="w"> </span>-s<span class="w"> </span><span class="s1">&#39;import numpy as np; n = 20000 ; lat, lon = np.random.rand(n), np.random.rand(n); x,y = np.random.rand(), np.random.rand(); from cda import closest_distance_arrays&#39;</span><span class="w"> </span><span class="s1">&#39;closest_distance_arrays(x,y,lat, lon)&#39;</span>
<span class="m">1000</span><span class="w"> </span>loops,<span class="w"> </span>best<span class="w"> </span>of<span class="w"> </span><span class="m">3</span>:<span class="w"> </span><span class="m">1</span>.15<span class="w"> </span>msec<span class="w"> </span>per<span class="w"> </span>loop
</pre></div>
<p>All these flags are now the default on Linux.</p>
</div>
<div class="section" id="playing-with-the-optimization-flags-too">
<h2>Playing with the optimization flags too</h2>
<p>The default optimization flag is <tt class="docutils literal"><span class="pre">-O2</span></tt>, and that's generally a decent choice.
On <tt class="docutils literal">cda.py</tt>, using <tt class="docutils literal"><span class="pre">-O3</span></tt> does not give much change (gcc 4.9):</p>
<div class="highlight"><pre><span></span>&gt;<span class="w"> </span>pythran<span class="w"> </span>cda.py<span class="w"> </span>-fvisibility<span class="o">=</span>hidden<span class="w"> </span>-fwhole-program<span class="w"> </span>-Wl,-strip-all<span class="w"> </span>-O3
&gt;<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>timeit<span class="w"> </span><span class="o">[</span>...<span class="o">]</span>
<span class="m">1000</span><span class="w"> </span>loops,<span class="w"> </span>best<span class="w"> </span>of<span class="w"> </span><span class="m">3</span>:<span class="w"> </span><span class="m">1</span>.14<span class="w"> </span>msec<span class="w"> </span>per<span class="w"> </span>loop
</pre></div>
<p>Asking for code specific to my CPU using <tt class="docutils literal"><span class="pre">-march=native</span></tt> actually gives some improvments</p>
<div class="highlight"><pre><span></span>&gt;<span class="w"> </span>pythran<span class="w"> </span>cda.py<span class="w"> </span>-fvisibility<span class="o">=</span>hidden<span class="w"> </span>-fwhole-program<span class="w"> </span>-Wl,-strip-all<span class="w"> </span>-O3<span class="w"> </span>-march<span class="o">=</span>native
&gt;<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>timeit<span class="w"> </span><span class="o">[</span>...<span class="o">]</span>
<span class="m">1000</span><span class="w"> </span>loops,<span class="w"> </span>best<span class="w"> </span>of<span class="w"> </span><span class="m">3</span>:<span class="w"> </span><span class="m">1</span>.11<span class="w"> </span>msec<span class="w"> </span>per<span class="w"> </span>loop
</pre></div>
<p>But the best speedup has a price: relaxing standard compliance with <tt class="docutils literal"><span class="pre">-Ofast</span></tt>
can be beneficial if you're not using denormalized numbers, infinity and the
monstrosity that lies with <tt class="docutils literal">NaN</tt>:</p>
<div class="highlight"><pre><span></span>&gt;<span class="w"> </span>pythran<span class="w"> </span>cda.py<span class="w"> </span>-fvisibility<span class="o">=</span>hidden<span class="w"> </span>-fwhole-program<span class="w"> </span>-Wl,-strip-all<span class="w"> </span>-Ofast<span class="w"> </span>-march<span class="o">=</span>native
&gt;<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>timeit<span class="w"> </span><span class="o">[</span>...<span class="o">]</span>
<span class="m">1000</span><span class="w"> </span>loops,<span class="w"> </span>best<span class="w"> </span>of<span class="w"> </span><span class="m">3</span>:<span class="w"> </span><span class="m">1</span>.02<span class="w"> </span>msec<span class="w"> </span>per<span class="w"> </span>loop
</pre></div>
<p>If you're really into compiler flags tuning, you can try out <tt class="docutils literal"><span class="pre">-funroll-loops</span></tt>
or try to tune the <tt class="docutils literal"><span class="pre">-finline-limit=N</span></tt> parameter (that actually get mets dow
to <tt class="docutils literal">1ms per loop</tt>) but that's going a bit too far :-)</p>
</div>
<div class="section" id="don-t-forget-vectorization">
<h2>Don't forget Vectorization</h2>
<p>Combining <tt class="docutils literal"><span class="pre">-O3</span></tt> and <tt class="docutils literal"><span class="pre">-march=native</span></tt> triggers compiler auto-vectorization[2]_,
but that did not helped much on our case. Indeed, automatic vectorization, as
in « I am using the multimedia instruction set of my CPU » is still a difficult
task for compilers. Fortunately Pythran helps here, and passing the
not-so-experimental-anymore-but-still-not-default flag <tt class="docutils literal"><span class="pre">-DUSE_BOOST_SIMD</span></tt>
triggers some hard-coded vectorization based on <tt class="docutils literal">boost.simd</tt> <a class="footnote-reference" href="#footnote-4" id="footnote-reference-3">[3]</a>, and that
<strong>did</strong> help:</p>
<div class="highlight"><pre><span></span>&gt;<span class="w"> </span><span class="c1"># esod mumixam</span>
&gt;<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pythran.run<span class="w"> </span>cda.cpp<span class="w"> </span>-fvisibility<span class="o">=</span>hidden<span class="w"> </span>-fwhole-program<span class="w"> </span>-Wl,-strip-all<span class="w"> </span>-Ofast<span class="w"> </span>-march<span class="o">=</span>native<span class="w"> </span>-funroll-loops<span class="w"> </span>-finline-limit<span class="o">=</span><span class="m">100000000</span><span class="w"> </span>-DUSE_BOOST_SIMD
&gt;<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>timeit<span class="w"> </span><span class="o">[</span>...<span class="o">]</span>
<span class="m">1000</span><span class="w"> </span>loops,<span class="w"> </span>best<span class="w"> </span>of<span class="w"> </span><span class="m">3</span>:<span class="w"> </span><span class="m">462</span><span class="w"> </span>usec<span class="w"> </span>per<span class="w"> </span>loo
</pre></div>
<p>And that's woth 63 kilobytes :-)</p>
</div>
<div class="section" id="concluding-remarks">
<h2>Concluding Remarks</h2>
<p>Source-to-source compilers <em>do</em> generate ugly intermediate code, and Pythran is
not an exception. One benefit though is that you can get a full control over
the <em>backend</em> compiler, which means you can tune it to your needs. Given some
knowledge and benchmarking effort, it can get you closer to your goal without
changing the original code.</p>
<table class="docutils footnote" frame="void" id="footnote-1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-1">[0]</a></td><td>And I am shamelessly advertising it :-) <a class="reference external" href="http://blog.quarkslab.com/clang-hardening-cheat-sheet.html">http://blog.quarkslab.com/clang-hardening-cheat-sheet.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="footnote-2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-2">[1]</a></td><td>If you really want to inspect the intermediate C++ code generated by pythran use the <tt class="docutils literal"><span class="pre">-E</span></tt> flag and a <tt class="docutils literal">cda.cpp</tt> will be generated.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="footnote-3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[2]</td><td>only GCC needs this, clang turns vectorisation at <tt class="docutils literal"><span class="pre">-O2</span></tt>. <tt class="docutils literal"><span class="pre">-march=native</span></tt> allows it to use a more recent instruction set if available.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="footnote-4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-3">[3]</a></td><td>Thanks Numscale <a class="reference external" href="https://www.numscale.com/boost-simd/">https://www.numscale.com/boost-simd/</a></td></tr>
</tbody>
</table>
</div>

    </article>
    <section class="post-nav">
        <div id="left-page">
            <div id="left-link">
            </div>
        </div>
        <div id="right-page">
            <div id="right-link">
            </div>
        </div>
    </section>
    <div>
    </div>
</main>
    <footer>
        <h6>
            Rendered by <a href="http://getpelican.com/">Pelican</a> &nbsp;&bull;&nbsp; Theme by <a
                href="https://github.com/aleylara/Peli-Kiera">Peli-Kiera</a> &nbsp;&bull;&nbsp; Copyright
                &copy &nbsp;&#8209;&nbsp; serge-sans-paille and other pythraners         </h6>
    </footer>
</div>
</body>
</html>
