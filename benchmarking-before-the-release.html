<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Benchmarking Before the Release</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="serge-sans-paille and other pythraners">

    <!-- Le styles -->
    <link rel="stylesheet" href="./theme/css/bootstrap.min.css" type="text/css" />
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
      .tag-1 {
        font-size: 13pt;
      }
      .tag-2 {
        font-size: 10pt;
      }
      .tag-2 {
        font-size: 8pt;
      }
      .tag-4 {
        font-size: 6pt;
     }
    </style>
    <link href="./theme/css/bootstrap-responsive.min.css" rel="stylesheet">
        <link href="./theme/css/font-awesome.css" rel="stylesheet">

    <link href="./theme/css/pygments.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="./theme/images/favicon.ico">
    <link rel="apple-touch-icon" href="./theme/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="./theme/images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="./theme/images/apple-touch-icon-114x114.png">

    <link href="./" type="application/atom+xml" rel="alternate" title="Pythran stories ATOM Feed" />

  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="./index.html">Pythran stories </a>
          <div class="nav-collapse">
            <ul class="nav">
                          <li class="divider-vertical"></li>
                  <li class="active">
                    <a href="./category/benchmark.html">
						<i class="icon-folder-open icon-large"></i>benchmark
					</a>
                  </li>
                  <li >
                    <a href="./category/compilation.html">
						<i class="icon-folder-open icon-large"></i>compilation
					</a>
                  </li>
                  <li >
                    <a href="./category/cython.html">
						<i class="icon-folder-open icon-large"></i>cython
					</a>
                  </li>
                  <li >
                    <a href="./category/engineering.html">
						<i class="icon-folder-open icon-large"></i>engineering
					</a>
                  </li>
                  <li >
                    <a href="./category/examples.html">
						<i class="icon-folder-open icon-large"></i>examples
					</a>
                  </li>
                  <li >
                    <a href="./category/optimisation.html">
						<i class="icon-folder-open icon-large"></i>optimisation
					</a>
                  </li>
                  <li >
                    <a href="./category/release.html">
						<i class="icon-folder-open icon-large"></i>release
					</a>
                  </li>

                          <ul class="nav pull-right">
                                <li><a href="./archives.html"><i class="icon-th-list"></i>Archives</a></li>
                          </ul>

            </ul>
            <!--<p class="navbar-text pull-right">Logged in as <a href="#">username</a></p>-->
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row">
        <div class="span9" id="content">
<section id="content">
        <article>
                <header>
                        <h1>
                                <a href=""
                                        rel="bookmark"
                                        title="Permalink to Benchmarking Before the Release">
                                        Benchmarking Before the Release
                                </a>
                        </h1>
                </header>
                <div class="entry-content">
                <div class="well">
<footer class="post-info">
<span class="label">Date</span>
<abbr class="published" title="2016-06-08T00:00:00+02:00">
        <i class="icon-calendar"></i>Wed 08 June 2016
</abbr>
<span class="label">By</span>
<a href="./author/serge-sans-paille.html"><i class="icon-user"></i>serge-sans-paille</a>
<span class="label">Category</span>
<a href="./category/benchmark.html"><i class="icon-folder-open"></i>benchmark</a>.


</footer><!-- /.post-info -->                </div>
                <p>This blogpost originally was a Jupyter Notebook. You can <a href="notebooks/Benchmarking Before the Release.ipynb">download it</a> if you want. The conversion was done using <code>nbconvert</code> and a <a href="notebooks/nbmarkdown.tpl">custom template</a> to match the style of the other part of the blog.</p>
<p>The goal of this notebook is to look for performance regression in Pythran before its release. To do so, several cython kernels have been collected on the World Wide Web, mostly from stackoverflow and blogs.</p>
<p>For each kernel, a Numpy version, a Cython version and a Pythran version (which aims to be equal to the Numpy version, with an additional <code>#pythran export</code>) are benchmarked. If Pythran can rip the same performance level as Cython from the Numpy -like code, then it's ok for the release!</p>
<h1>Disclaimer</h1>
<p>Benchmarking is a difficult task. This notebook does not aim to be a reference comparison between Cython and Pythran. So many factors are involved: the developper proficiency in Cython, Numpy and Pythran, the underlying C compiler, or C++ compiler (we made sure they were using the same gcc version, at least), their respective compilation flags (they are different, but both use  <code>-O2</code> and <strong>not</strong> <code>-ffast-math</code>), the Pythran/Cython version… So take it as it is: a way to make sure the Pythran developpers did not miss an obvious optimization opportunity, or introduced a performance regression. No other conclusions should be made without great care.</p>
<h1>Setup</h1>
<p>The happy few:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="o">&gt;&gt;&gt;</span> <span class="o">%</span><span class="n">load_ext</span> <span class="n">Cython</span>
<span class="o">&gt;&gt;&gt;</span> <span class="o">%</span><span class="n">load_ext</span> <span class="n">pythran</span><span class="o">.</span><span class="n">magic</span>
</pre></div>


<p>The benchmarking routine:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">timeit</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">pandas</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="o">&gt;&gt;&gt;</span> <span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">run_bench</span><span class="p">(</span><span class="n">functions</span><span class="p">,</span> <span class="n">sizes</span><span class="p">,</span> <span class="n">args_factory</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">global</span> <span class="n">function</span><span class="p">,</span> <span class="n">args</span>  <span class="c1"># to please timeit</span>
<span class="o">...</span>     <span class="n">scores</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">functions</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">index</span><span class="o">=</span><span class="n">sizes</span><span class="p">)</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">sizes</span><span class="p">:</span>
<span class="o">...</span>         <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
<span class="o">...</span>         <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">function</span> <span class="ow">in</span> <span class="n">functions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="o">...</span>             <span class="n">args</span> <span class="o">=</span> <span class="n">args_factory</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
<span class="o">...</span>             <span class="n">result</span> <span class="o">=</span> <span class="o">%</span><span class="n">timeit</span> <span class="o">-</span><span class="n">q</span> <span class="o">-</span><span class="n">o</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="o">...</span>             <span class="n">scores</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">size</span><span class="p">,</span> <span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">best</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">scores</span>
</pre></div>


<h1>cos_norm</h1>
<p><em>source: <a href="http://stackoverflow.com/questions/32258905/optimization-and-speedup-of-a-mathematical-function-in-python">stackoverflow</a></em></p>
<p>This kernel tests classical element wise operations <em>à la</em> Numpy.</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">np_cos_norm</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">))</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">val</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">/</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%%</span><span class="n">cython</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="n">cimport</span> <span class="n">cython</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">cimport</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="n">cdef</span> <span class="n">extern</span> <span class="kn">from</span> <span class="s2">&quot;math.h&quot;</span><span class="p">:</span>
<span class="o">...</span>     <span class="n">double</span> <span class="n">cos</span><span class="p">(</span><span class="n">double</span> <span class="n">x</span><span class="p">)</span> <span class="n">nogil</span>
<span class="o">...</span>     <span class="n">double</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">double</span> <span class="n">x</span><span class="p">)</span> <span class="n">nogil</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">cython_cos_norm</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">cos_norm_impl</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="nd">@cython.boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nd">@cython.wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nd">@cython.cdivision</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">cdef</span> <span class="n">double</span> <span class="n">cos_norm_impl</span><span class="p">(</span><span class="n">double</span><span class="p">[::</span><span class="mi">1</span><span class="p">]</span> <span class="n">a</span><span class="p">,</span> <span class="n">double</span><span class="p">[::</span><span class="mi">1</span><span class="p">]</span> <span class="n">b</span><span class="p">)</span> <span class="n">nogil</span><span class="p">:</span>
<span class="o">...</span>     <span class="n">cdef</span> <span class="n">double</span> <span class="n">res</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">val</span>
<span class="o">...</span>     <span class="n">cdef</span> <span class="nb">int</span> <span class="n">m</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="o">...</span>     <span class="c1"># XXX: shape of b not checked</span>
<span class="o">...</span>     <span class="n">cdef</span> <span class="nb">int</span> <span class="n">j</span>
<span class="o">...</span> 
<span class="o">...</span>     <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
<span class="o">...</span>         <span class="n">val</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
<span class="o">...</span>         <span class="n">res</span> <span class="o">+=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">cos</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">res</span> <span class="o">/=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">m</span>
<span class="o">...</span> 
<span class="o">...</span>     <span class="k">return</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%%</span><span class="n">pythran</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="c1">#pythran export pythran_cos_norm(float[], float[])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">pythran_cos_norm</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">))</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">val</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">/</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>


<h2>Timings (lower is better)</h2>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">cos_norms</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="s1">&#39;numpy&#39;</span><span class="p">,</span> <span class="n">np_cos_norm</span><span class="p">),</span>
<span class="o">...</span>                          <span class="p">(</span><span class="s1">&#39;cython&#39;</span><span class="p">,</span> <span class="n">cython_cos_norm</span><span class="p">),</span>
<span class="o">...</span>                          <span class="p">(</span><span class="s1">&#39;pythran&#39;</span><span class="p">,</span> <span class="n">pythran_cos_norm</span><span class="p">)])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">sizes</span> <span class="o">=</span> <span class="mf">1e3</span><span class="p">,</span> <span class="mf">1e4</span><span class="p">,</span> <span class="mf">1e5</span><span class="p">,</span> <span class="mf">1e6</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">args_factory</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">),</span>
<span class="o">...</span>             <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">scores</span> <span class="o">=</span> <span class="n">run_bench</span><span class="p">(</span><span class="n">cos_norms</span><span class="p">,</span> <span class="n">sizes</span><span class="p">,</span> <span class="n">args_factory</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">scores</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span>&amp;lt;matplotlib.axes._subplots.AxesSubplot at 0x7fa4eb26c2d0&amp;gt;
</pre></div>


<p><img alt="png" src="Benchmarking%20Before%20the%20Release_files/Benchmarking%20Before%20the%20Release_10_1.png"></p>
<p>That's unexpected! The reason why we go faster than Cython is the <code>cos</code> routine, as we use <a href="http://nt2.numscale.com/">nt2</a> implementation that proves to be very efficient (it has a few shortpaths). Switching back to <code>std::cos</code> gives the same execution time has Cython.</p>
<h1>Grayscott</h1>
<p><em>source: <a href="http://stackoverflow.com/questions/26823312/numba-or-cython-acceleration-in-reaction-diffusion-algorithm">stackoverflow</a></em></p>
<p>This kernel tests complex array interactions: slices, element-wise operations, everything into a regular loop!</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">np_grayscott</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">Du</span><span class="p">,</span> <span class="n">Dv</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">n</span> <span class="o">=</span> <span class="mi">300</span>
<span class="o">...</span>     <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float_</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float_</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="o">...</span> 
<span class="o">...</span>     <span class="n">r</span> <span class="o">=</span> <span class="mi">20</span>
<span class="o">...</span>     <span class="n">u</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="o">...</span>     <span class="n">U</span><span class="p">[</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">r</span><span class="p">:</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">r</span><span class="p">:</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.50</span>
<span class="o">...</span>     <span class="n">V</span><span class="p">[</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">r</span><span class="p">:</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">r</span><span class="p">:</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.25</span>
<span class="o">...</span>     <span class="n">u</span> <span class="o">+=</span> <span class="mf">0.15</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
<span class="o">...</span>     <span class="n">v</span> <span class="o">+=</span> <span class="mf">0.15</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
<span class="o">...</span> 
<span class="o">...</span>     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">counts</span><span class="p">):</span>
<span class="o">...</span>         <span class="n">Lu</span> <span class="o">=</span> <span class="p">(</span>                 <span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
<span class="o">...</span>               <span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">4</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:]</span> <span class="o">+</span>
<span class="o">...</span>                                <span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span>  <span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
<span class="o">...</span>         <span class="n">Lv</span> <span class="o">=</span> <span class="p">(</span>                 <span class="n">V</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
<span class="o">...</span>               <span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">4</span><span class="o">*</span><span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:]</span> <span class="o">+</span>
<span class="o">...</span>                                <span class="n">V</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span>  <span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
<span class="o">...</span>         <span class="n">uvv</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">v</span>
<span class="o">...</span>         <span class="n">u</span> <span class="o">+=</span> <span class="n">Du</span><span class="o">*</span><span class="n">Lu</span> <span class="o">-</span> <span class="n">uvv</span> <span class="o">+</span> <span class="n">F</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">u</span><span class="p">)</span>
<span class="o">...</span>         <span class="n">v</span> <span class="o">+=</span> <span class="n">Dv</span><span class="o">*</span><span class="n">Lv</span> <span class="o">+</span> <span class="n">uvv</span> <span class="o">-</span> <span class="p">(</span><span class="n">F</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">v</span>
<span class="o">...</span> 
<span class="o">...</span>     <span class="k">return</span> <span class="n">V</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%%</span><span class="n">cython</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="n">cimport</span> <span class="n">cython</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">cimport</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="nd">@cython.boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nd">@cython.wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nd">@cython.cdivision</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">cpdef</span> <span class="n">cython_grayscott</span><span class="p">(</span><span class="nb">int</span> <span class="n">counts</span><span class="p">,</span> <span class="n">double</span> <span class="n">Du</span><span class="p">,</span> <span class="n">double</span> <span class="n">Dv</span><span class="p">,</span> <span class="n">double</span> <span class="n">F</span><span class="p">,</span> <span class="n">double</span> <span class="n">k</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">cdef</span> <span class="nb">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">300</span>
<span class="o">...</span>     <span class="n">cdef</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float_</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">cdef</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float_</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">cdef</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="n">u</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="o">...</span>     <span class="n">cdef</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="n">v</span> <span class="o">=</span> <span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="o">...</span> 
<span class="o">...</span>     <span class="n">cdef</span> <span class="nb">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">20</span>
<span class="o">...</span>     <span class="n">u</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="o">...</span>     <span class="n">U</span><span class="p">[</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">r</span><span class="p">:</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">r</span><span class="p">:</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.50</span>
<span class="o">...</span>     <span class="n">V</span><span class="p">[</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">r</span><span class="p">:</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">r</span><span class="p">:</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.25</span>
<span class="o">...</span>     <span class="n">u</span> <span class="o">+=</span> <span class="mf">0.15</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
<span class="o">...</span>     <span class="n">v</span> <span class="o">+=</span> <span class="mf">0.15</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
<span class="o">...</span> 
<span class="o">...</span>     <span class="n">cdef</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="n">Lu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">cdef</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="n">Lv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">cdef</span> <span class="nb">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">c2</span>
<span class="o">...</span>     <span class="n">cdef</span> <span class="n">double</span> <span class="n">uvv</span>
<span class="o">...</span> 
<span class="o">...</span>     <span class="n">cdef</span> <span class="n">double</span><span class="p">[:,</span> <span class="p">::</span><span class="mi">1</span><span class="p">]</span> <span class="n">bU</span> <span class="o">=</span> <span class="n">U</span>
<span class="o">...</span>     <span class="n">cdef</span> <span class="n">double</span><span class="p">[:,</span> <span class="p">::</span><span class="mi">1</span><span class="p">]</span> <span class="n">bV</span> <span class="o">=</span> <span class="n">V</span>
<span class="o">...</span>     <span class="n">cdef</span> <span class="n">double</span><span class="p">[:,</span> <span class="p">::</span><span class="mi">1</span><span class="p">]</span> <span class="n">bLu</span> <span class="o">=</span> <span class="n">Lu</span>
<span class="o">...</span>     <span class="n">cdef</span> <span class="n">double</span><span class="p">[:,</span> <span class="p">::</span><span class="mi">1</span><span class="p">]</span> <span class="n">bLv</span> <span class="o">=</span> <span class="n">Lv</span>
<span class="o">...</span> 
<span class="o">...</span>     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">counts</span><span class="p">):</span>
<span class="o">...</span>         <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="o">...</span>             <span class="n">r1</span> <span class="o">=</span> <span class="n">r</span> <span class="o">+</span> <span class="mi">1</span>
<span class="o">...</span>             <span class="n">r2</span> <span class="o">=</span> <span class="n">r</span> <span class="o">+</span> <span class="mi">2</span>
<span class="o">...</span>             <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="o">...</span>                 <span class="n">c1</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="mi">1</span>
<span class="o">...</span>                 <span class="n">c2</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="mi">2</span>
<span class="o">...</span>                 <span class="n">bLu</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">bU</span><span class="p">[</span><span class="n">r1</span><span class="p">,</span><span class="n">c2</span><span class="p">]</span> <span class="o">+</span> <span class="n">bU</span><span class="p">[</span><span class="n">r1</span><span class="p">,</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="n">bU</span><span class="p">[</span><span class="n">r2</span><span class="p">,</span><span class="n">c1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bU</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">c1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">4</span><span class="o">*</span><span class="n">bU</span><span class="p">[</span><span class="n">r1</span><span class="p">,</span><span class="n">c1</span><span class="p">]</span>
<span class="o">...</span>                 <span class="n">bLv</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">bV</span><span class="p">[</span><span class="n">r1</span><span class="p">,</span><span class="n">c2</span><span class="p">]</span> <span class="o">+</span> <span class="n">bV</span><span class="p">[</span><span class="n">r1</span><span class="p">,</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="n">bV</span><span class="p">[</span><span class="n">r2</span><span class="p">,</span><span class="n">c1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bV</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">c1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">4</span><span class="o">*</span><span class="n">bV</span><span class="p">[</span><span class="n">r1</span><span class="p">,</span><span class="n">c1</span><span class="p">]</span>
<span class="o">...</span> 
<span class="o">...</span>         <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="o">...</span>             <span class="n">r1</span> <span class="o">=</span> <span class="n">r</span> <span class="o">+</span> <span class="mi">1</span>
<span class="o">...</span>             <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="o">...</span>                 <span class="n">c1</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="mi">1</span>
<span class="o">...</span>                 <span class="n">uvv</span> <span class="o">=</span> <span class="n">bU</span><span class="p">[</span><span class="n">r1</span><span class="p">,</span><span class="n">c1</span><span class="p">]</span><span class="o">*</span><span class="n">bV</span><span class="p">[</span><span class="n">r1</span><span class="p">,</span><span class="n">c1</span><span class="p">]</span><span class="o">*</span><span class="n">bV</span><span class="p">[</span><span class="n">r1</span><span class="p">,</span><span class="n">c1</span><span class="p">]</span>
<span class="o">...</span>                 <span class="n">bU</span><span class="p">[</span><span class="n">r1</span><span class="p">,</span><span class="n">c1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Du</span><span class="o">*</span><span class="n">bLu</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span> <span class="o">-</span> <span class="n">uvv</span> <span class="o">+</span> <span class="n">F</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">bU</span><span class="p">[</span><span class="n">r1</span><span class="p">,</span><span class="n">c1</span><span class="p">])</span>
<span class="o">...</span>                 <span class="n">bV</span><span class="p">[</span><span class="n">r1</span><span class="p">,</span><span class="n">c1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Dv</span><span class="o">*</span><span class="n">bLv</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="n">uvv</span> <span class="o">-</span> <span class="p">(</span><span class="n">F</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">bV</span><span class="p">[</span><span class="n">r1</span><span class="p">,</span><span class="n">c1</span><span class="p">]</span>
<span class="o">...</span> 
<span class="o">...</span>     <span class="k">return</span> <span class="n">V</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%%</span><span class="n">pythran</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="c1">#pythran export pythran_grayscott(int, float, float, float, float)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">pythran_grayscott</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">Du</span><span class="p">,</span> <span class="n">Dv</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">n</span> <span class="o">=</span> <span class="mi">300</span>
<span class="o">...</span>     <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float_</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float_</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="o">...</span> 
<span class="o">...</span>     <span class="n">r</span> <span class="o">=</span> <span class="mi">20</span>
<span class="o">...</span>     <span class="n">u</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="o">...</span>     <span class="n">U</span><span class="p">[</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">r</span><span class="p">:</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">r</span><span class="p">:</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.50</span>
<span class="o">...</span>     <span class="n">V</span><span class="p">[</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">r</span><span class="p">:</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">r</span><span class="p">:</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.25</span>
<span class="o">...</span>     <span class="n">u</span> <span class="o">+=</span> <span class="mf">0.15</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
<span class="o">...</span>     <span class="n">v</span> <span class="o">+=</span> <span class="mf">0.15</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
<span class="o">...</span> 
<span class="o">...</span>     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">counts</span><span class="p">):</span>
<span class="o">...</span>         <span class="n">Lu</span> <span class="o">=</span> <span class="p">(</span>                 <span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
<span class="o">...</span>               <span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">4</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:]</span> <span class="o">+</span>
<span class="o">...</span>                                <span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span>  <span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
<span class="o">...</span>         <span class="n">Lv</span> <span class="o">=</span> <span class="p">(</span>                 <span class="n">V</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
<span class="o">...</span>               <span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">4</span><span class="o">*</span><span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:]</span> <span class="o">+</span>
<span class="o">...</span>                                <span class="n">V</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span>  <span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
<span class="o">...</span>         <span class="n">uvv</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="n">v</span><span class="o">*</span><span class="n">v</span>
<span class="o">...</span>         <span class="n">u</span> <span class="o">+=</span> <span class="n">Du</span><span class="o">*</span><span class="n">Lu</span> <span class="o">-</span> <span class="n">uvv</span> <span class="o">+</span> <span class="n">F</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">u</span><span class="p">)</span>
<span class="o">...</span>         <span class="n">v</span> <span class="o">+=</span> <span class="n">Dv</span><span class="o">*</span><span class="n">Lv</span> <span class="o">+</span> <span class="n">uvv</span> <span class="o">-</span> <span class="p">(</span><span class="n">F</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">v</span>
<span class="o">...</span> 
<span class="o">...</span>     <span class="k">return</span> <span class="n">V</span>
</pre></div>


<h2>Timings (lower is better)</h2>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">grayscotts</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="s1">&#39;numpy&#39;</span><span class="p">,</span> <span class="n">np_grayscott</span><span class="p">),</span>
<span class="o">...</span>                           <span class="p">(</span><span class="s1">&#39;cython&#39;</span><span class="p">,</span> <span class="n">cython_grayscott</span><span class="p">),</span>
<span class="o">...</span>                           <span class="p">(</span><span class="s1">&#39;pythran&#39;</span><span class="p">,</span> <span class="n">pythran_grayscott</span><span class="p">)])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">sizes</span> <span class="o">=</span> <span class="mf">1e1</span><span class="p">,</span> <span class="mf">5e1</span><span class="p">,</span> <span class="mf">1e2</span><span class="p">,</span> <span class="mf">5e2</span><span class="p">,</span> <span class="mf">1e3</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">args_factory</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">size</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.06</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">scores</span> <span class="o">=</span> <span class="n">run_bench</span><span class="p">(</span><span class="n">grayscotts</span><span class="p">,</span> <span class="n">sizes</span><span class="p">,</span> <span class="n">args_factory</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">scores</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span>&amp;lt;matplotlib.axes._subplots.AxesSubplot at 0x7fa4e5f8ff10&amp;gt;
</pre></div>


<p><img alt="png" src="Benchmarking%20Before%20the%20Release_files/Benchmarking%20Before%20the%20Release_18_1.png"></p>
<p>We have a small issue there. Need to investigate! Still a decent speedup though.</p>
<h1>clip</h1>
<p><em>source: <a href="https://github.com/serge-sans-paille/pythran/issues/433">pythran issue</a></em></p>
<p>This kernel tests conditionnal assignment (through <code>np.where</code>) and array of complex numbers.</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">np_clip</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">_max</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">_max</span><span class="p">,</span> <span class="n">z</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">_max</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%%</span><span class="n">cython</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="n">cimport</span> <span class="n">cython</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">cimport</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="n">cdef</span> <span class="n">extern</span> <span class="kn">from</span> <span class="s2">&quot;complex.h&quot;</span><span class="p">:</span>
<span class="o">...</span>     <span class="n">double</span> <span class="n">cabs</span><span class="p">(</span><span class="n">double</span> <span class="nb">complex</span> <span class="n">x</span><span class="p">)</span> <span class="n">nogil</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="nd">@cython.boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nd">@cython.wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nd">@cython.cdivision</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">cpdef</span> <span class="n">cython_clip</span> <span class="p">(</span><span class="n">double</span> <span class="nb">complex</span><span class="p">[::</span><span class="mi">1</span><span class="p">]</span> <span class="n">z</span><span class="p">,</span> <span class="n">double</span> <span class="n">_max</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">cdef</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="n">out_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">cdef</span> <span class="nb">int</span> <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">i</span>
<span class="o">...</span>     <span class="n">cdef</span> <span class="n">double</span> <span class="nb">complex</span><span class="p">[::</span><span class="mi">1</span><span class="p">]</span> <span class="n">out</span> <span class="o">=</span> <span class="n">out_</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="o">...</span>         <span class="k">if</span> <span class="n">cabs</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">_max</span><span class="p">:</span>
<span class="o">...</span>             <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">cabs</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">_max</span>
<span class="o">...</span>         <span class="k">else</span><span class="p">:</span>
<span class="o">...</span>             <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="o">...</span> 
<span class="o">...</span>     <span class="k">return</span> <span class="n">out</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%%</span><span class="n">pythran</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="c1">#pythran export pythran_clip(complex128[], float64)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">pythran_clip</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">_max</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">_max</span><span class="p">,</span> <span class="n">z</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">_max</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</pre></div>


<h2>Timings (lower is better)</h2>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">clips</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="s1">&#39;numpy&#39;</span><span class="p">,</span> <span class="n">np_clip</span><span class="p">),</span>
<span class="o">...</span>                      <span class="p">(</span><span class="s1">&#39;cython&#39;</span><span class="p">,</span> <span class="n">cython_clip</span><span class="p">),</span>
<span class="o">...</span>                      <span class="p">(</span><span class="s1">&#39;pythran&#39;</span><span class="p">,</span> <span class="n">pythran_clip</span><span class="p">)])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">sizes</span> <span class="o">=</span> <span class="mf">1e2</span><span class="p">,</span> <span class="mf">1e3</span><span class="p">,</span> <span class="mf">1e4</span><span class="p">,</span> <span class="mf">1e5</span><span class="p">,</span> <span class="mf">1e6</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">args_factory</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span> <span class="o">*</span> <span class="nb">complex</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">size</span><span class="o">/</span><span class="mi">2</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">scores</span> <span class="o">=</span> <span class="n">run_bench</span><span class="p">(</span><span class="n">clips</span><span class="p">,</span> <span class="n">sizes</span><span class="p">,</span> <span class="n">args_factory</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">scores</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span>&amp;lt;matplotlib.axes._subplots.AxesSubplot at 0x7fa4eb4e8990&amp;gt;
</pre></div>


<p><img alt="png" src="Benchmarking%20Before%20the%20Release_files/Benchmarking%20Before%20the%20Release_26_1.png"></p>
<p>Nice! Brest! Slightly worse than Cython, but we could improve this by implementing common subexpression elimination at the array level.</p>
<h1>Pariwise distance</h1>
<p><em>sources: <a href="http://jakevdp.github.io/blog/2012/08/24/numba-vs-cython/">jakevdp blog</a> and
<a href="https://anaconda.org/tonyfast/numbacythonredux/notebook">Anaconda blog</a></em></p>
<p>This kernel tests Numpy's broadcasting.</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">np_pairwise</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">X</span><span class="p">[:,</span> <span class="bp">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">X</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%%</span><span class="n">cython</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">cimport</span> <span class="n">cython</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">libc.math</span> <span class="nn">cimport</span> <span class="nn">sqrt</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="nd">@cython.boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nd">@cython.wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">cython_pairwise</span><span class="p">(</span><span class="n">double</span><span class="p">[:,</span> <span class="p">::</span><span class="mi">1</span><span class="p">]</span> <span class="n">X</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">cdef</span> <span class="nb">int</span> <span class="n">M</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="o">...</span>     <span class="n">cdef</span> <span class="nb">int</span> <span class="n">N</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="o">...</span>     <span class="n">cdef</span> <span class="n">double</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">d</span>
<span class="o">...</span>     <span class="n">cdef</span> <span class="n">double</span><span class="p">[:,</span> <span class="p">::</span><span class="mi">1</span><span class="p">]</span> <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
<span class="o">...</span>         <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
<span class="o">...</span>             <span class="n">d</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="o">...</span>             <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
<span class="o">...</span>                 <span class="n">tmp</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">X</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span>
<span class="o">...</span>                 <span class="n">d</span> <span class="o">+=</span> <span class="n">tmp</span> <span class="o">*</span> <span class="n">tmp</span>
<span class="o">...</span>             <span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%%</span><span class="n">pythran</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="c1">#pythran export pythran_pairwise(float64 [][])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">pythran_pairwise</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">X</span><span class="p">[:,</span> <span class="bp">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">X</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</pre></div>


<h2>Timings</h2>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">pairwises</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="s1">&#39;numpy&#39;</span><span class="p">,</span> <span class="n">np_pairwise</span><span class="p">),</span>
<span class="o">...</span>                          <span class="p">(</span><span class="s1">&#39;cython&#39;</span><span class="p">,</span> <span class="n">cython_pairwise</span><span class="p">),</span>
<span class="o">...</span>                          <span class="p">(</span><span class="s1">&#39;pythran&#39;</span><span class="p">,</span> <span class="n">pythran_pairwise</span><span class="p">)])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">sizes</span> <span class="o">=</span> <span class="mf">0.5e2</span><span class="p">,</span> <span class="mf">1e2</span><span class="p">,</span> <span class="mf">2.5e2</span><span class="p">,</span> <span class="mf">5e2</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">args_factory</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">)),</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">scores</span> <span class="o">=</span> <span class="n">run_bench</span><span class="p">(</span><span class="n">pairwises</span><span class="p">,</span> <span class="n">sizes</span><span class="p">,</span> <span class="n">args_factory</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">scores</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span>&amp;lt;matplotlib.axes._subplots.AxesSubplot at 0x7fa4eb44ab10&amp;gt;
</pre></div>


<p><img alt="png" src="Benchmarking%20Before%20the%20Release_files/Benchmarking%20Before%20the%20Release_34_1.png"></p>
<p>Wooo! Being able to compile this expression down to something that matches Cython's generated code is an achivement :-)</p>
<h1>lu factorization</h1>
<p><em>source: <a href="https://www.ibm.com/developerworks/community/blogs/jfp/entry/A_Comparison_Of_C_Julia_Python_Numba_Cython_Scipy_and_BLAS_on_LU_Factorization">jfp blog</a></em></p>
<p>This kernel tests interaction between Numpy arrays, slices and regular loops.</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">np_det_by_lu</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="o">...</span> 
<span class="o">...</span>     <span class="n">N</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="o">...</span>     <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
<span class="o">...</span>         <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
<span class="o">...</span>             <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
<span class="o">...</span>             <span class="n">xk</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
<span class="o">...</span>             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
<span class="o">...</span>                 <span class="n">xi</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="o">...</span>                 <span class="n">xi</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">/=</span> <span class="n">xk</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
<span class="o">...</span>                 <span class="n">xi</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-=</span> <span class="n">xi</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">xk</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
<span class="o">...</span> 
<span class="o">...</span> 
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%%</span><span class="n">cython</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">cython</span>
<span class="o">...</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="nd">@cython.boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nd">@cython.wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">cpdef</span> <span class="n">cython_det_by_lu</span><span class="p">(</span><span class="n">double</span><span class="p">[:]</span> <span class="n">y</span><span class="p">,</span> <span class="n">double</span><span class="p">[:,:]</span> <span class="n">x</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="o">...</span> 
<span class="o">...</span>     <span class="n">cdef</span> <span class="nb">int</span> <span class="n">N</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="o">...</span>     <span class="n">cdef</span> <span class="nb">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span>
<span class="o">...</span> 
<span class="o">...</span>     <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
<span class="o">...</span>         <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
<span class="o">...</span>         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
<span class="o">...</span>             <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">/=</span> <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
<span class="o">...</span>             <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
<span class="o">...</span>                 <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
<span class="o">...</span> 
<span class="o">...</span> 
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="o">%%</span><span class="n">pythran</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c1">#pythran export pythran_det_by_lu(float64 [:], float64[:,:])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">pythran_det_by_lu</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="o">...</span>     <span class="n">N</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="o">...</span>     
<span class="o">...</span>     <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
<span class="o">...</span>         <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
<span class="o">...</span>         <span class="n">xk</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
<span class="o">...</span>         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
<span class="o">...</span>             <span class="n">xi</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="o">...</span>             <span class="n">xi</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">/=</span> <span class="n">xk</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
<span class="o">...</span>             <span class="n">xi</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-=</span> <span class="n">xi</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">xk</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
</pre></div>


<h2>Timings</h2>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">det_by_lus</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="s1">&#39;numpy&#39;</span><span class="p">,</span> <span class="n">np_det_by_lu</span><span class="p">),</span>
<span class="o">...</span>                           <span class="p">(</span><span class="s1">&#39;cython&#39;</span><span class="p">,</span> <span class="n">cython_det_by_lu</span><span class="p">),</span>
<span class="o">...</span>                           <span class="p">(</span><span class="s1">&#39;pythran&#39;</span><span class="p">,</span> <span class="n">pythran_det_by_lu</span><span class="p">)])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">sizes</span> <span class="o">=</span> <span class="mf">1e2</span><span class="p">,</span> <span class="mf">2.5e2</span><span class="p">,</span> <span class="mf">5e2</span><span class="p">;</span> <span class="mf">7.5e2</span><span class="p">,</span> <span class="mf">1e3</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">args_factory</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">scores</span> <span class="o">=</span> <span class="n">run_bench</span><span class="p">(</span><span class="n">det_by_lus</span><span class="p">,</span> <span class="n">sizes</span><span class="p">,</span> <span class="n">args_factory</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">scores</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span>&amp;lt;matplotlib.axes._subplots.AxesSubplot at 0x7fa4eb4b66d0&amp;gt;
</pre></div>


<p><img alt="png" src="Benchmarking%20Before%20the%20Release_files/Benchmarking%20Before%20the%20Release_42_1.png"></p>
<p>On par with Cython, checked! Note that both Cython and Pythran kernel don't handle errors as Numpy kernel does…</p>
<h1>Conclusion</h1>
<p>Ready for release? Looks like everything is ok, we're most of the time not far from cython, while keeping the Numpy high-level calls <code>\o/</code></p>
<h1>Acknowledgments</h1>
<p>Thanks a lot to the authors of the cited blogs / stackoverflow threads for providing stimulating code samples. I did improve my cython king-fu a lot thanks to you!</p>
<p>(by order of apparition)</p>
<ul>
<li><a href="http://stackoverflow.com/users/5273154/noexit">NoExit</a></li>
<li><a href="http://stackoverflow.com/users/143765/ev-br">ev-br</a></li>
<li><a href="http://stackoverflow.com/users/4231346/snotna">snotna</a></li>
<li><a href="http://stackoverflow.com/users/772649/hyry">HYRY</a></li>
<li><a href="https://github.com/nbecker">ndbecker</a></li>
<li><a href="https://github.com/pbrunet">pbrunet</a></li>
<li><a href="http://staff.washington.edu/jakevdp/">Jake VanderPlas</a></li>
<li><a href="https://anaconda.org/tonyfast">tonyfast</a></li>
<li><a href="https://www.ibm.com/developerworks/community/profiles/html/profileView.do?userid=2700028FGP">Jean-Francois Puget</a></li>
</ul>
                </div><!-- /.entry-content -->
        </article>
</section>
        </div><!--/span-->

                <div class="span3 well sidebar-nav" id="sidebar">
<ul class="nav nav-list">
<li class="nav-header"><h4><i class="icon-external-link"></i>blogroll</h4></li>
    <li><a href="https://pythran.readthedocs.io"><i class="icon-external-link"></i>Pythran Doc</a></li>
    <li><a href="https://pypi.python.org/pypi/pythran"><i class="icon-external-link"></i>Pythran on PyPI</a></li>
<li class="nav-header"><h4><i class="icon-home icon-large"></i> social</h4></li>
<li><a href="./feeds/all.atom.xml" rel="alternate"><i class="icon-bookmark icon-large"></i>atom feed</a></li>
    <li><a href="https://github.com/serge-sans-paille/pythran"><i class="icon-github-sign icon-large"></i>github</a></li>

<li class="nav-header"><h4><i class="icon-folder-close icon-large"></i>Categories</h4></li>
<li>
<a href="./category/benchmark.html">
    <i class="icon-folder-open icon-large"></i>benchmark
</a>
</li>
<li>
<a href="./category/compilation.html">
    <i class="icon-folder-open icon-large"></i>compilation
</a>
</li>
<li>
<a href="./category/cython.html">
    <i class="icon-folder-open icon-large"></i>cython
</a>
</li>
<li>
<a href="./category/engineering.html">
    <i class="icon-folder-open icon-large"></i>engineering
</a>
</li>
<li>
<a href="./category/examples.html">
    <i class="icon-folder-open icon-large"></i>examples
</a>
</li>
<li>
<a href="./category/optimisation.html">
    <i class="icon-folder-open icon-large"></i>optimisation
</a>
</li>
<li>
<a href="./category/release.html">
    <i class="icon-folder-open icon-large"></i>release
</a>
</li>

<li class="nav-header"><h4><i class="icon-tags icon-large"></i>Tags</h4></li>


</ul>        </div><!--/.well -->

      </div><!--/row-->

      <hr>

      <footer>
        <address id="about">
                Proudly powered by <a href="http://pelican.notmyidea.org/">Pelican <i class="icon-external-link"></i></a>,
                                which takes great advantage of <a href="http://python.org">Python <i class="icon-external-link"></i></a>.
        </address><!-- /#about -->

        <p>The theme is from <a href="http://twitter.github.com/bootstrap/">Bootstrap from Twitter <i class="icon-external-link"></i></a>,
                   and <a href="http://fortawesome.github.com/Font-Awesome/">Font-Awesome <i class="icon-external-link"></i></a>, thanks!</p>
      </footer>

    </div><!--/.fluid-container-->



    <!-- Le javascript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="./theme/js/jquery-1.7.2.min.js"></script>
    <script src="./theme/js/bootstrap.min.js"></script>
  </body>
</html>